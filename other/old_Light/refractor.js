objTypes["refractor"]={p_name:"折射率",create:function(e){return{obj:{type:"refractor",path:[{x:e.x,y:e.y,arc:false}],notDone:true,p:1.2},draggingPart:{}}},draw:function(e,t){var n=t.getContext("2d");for(var r=0;r<e.path.length;r++){if(e.path[r].arc){n.fillStyle="rgb(255,0,255)";n.fillRect(e.path[r].x-3,e.path[r].y-3,5,5)}else{n.fillStyle="rgb(255,0,0)";n.fillRect(e.path[r].x-3,e.path[r].y-3,5,5)}}if(!e.notDone){n.beginPath();n.moveTo(e.path[0].x,e.path[0].y);for(var r=0;r<e.path.length;r++){if(e.path[(r+1)%e.path.length].arc&&!e.path[r%e.path.length].arc){var i=graphs.point(e.path[r%e.path.length].x,e.path[r%e.path.length].y);var s=graphs.point(e.path[(r+2)%e.path.length].x,e.path[(r+2)%e.path.length].y);var o=graphs.point(e.path[(r+1)%e.path.length].x,e.path[(r+1)%e.path.length].y);var u=graphs.intersection_2line(graphs.perpendicular_bisector(graphs.line(i,o)),graphs.perpendicular_bisector(graphs.line(s,o)));var a=graphs.length(u,o);var f=Math.atan2(i.y-u.y,i.x-u.x);var l=Math.atan2(s.y-u.y,s.x-u.x);var c=Math.atan2(o.y-u.y,o.x-u.x);var h=l<c&&c<f||f<l&&l<c||c<f&&f<l;n.arc(u.x,u.y,a,f,l,h)}else if(!e.path[(r+1)%e.path.length].arc&&!e.path[r%e.path.length].arc){n.lineTo(e.path[(r+1)%e.path.length].x,e.path[(r+1)%e.path.length].y)}}n.fillStyle="rgb(255,255,0)";n.globalAlpha=1-1/e.p;n.fill();n.globalAlpha=1;n.strokeStyle="rgb(0,0,0)";n.lineWidth=1;n.stroke()}},move:function(e,t,n){for(var r=0;r<e.path.length;r++){e.path[r].x+=t;e.path[r].y+=n}return e},clicked:function(e,t){if(e.notDone){if(mouseOnPoint(t,e.path[0])){e.notDone=false;return{obj:e}}else{e.path[e.path.length]={x:t.x,y:t.y,arc:false}}return{obj:e,draggingPart:{}}}for(var n=0;n<e.path.length;n++){if(mouseOnPoint(t,e.path[n])){return{draggingPart:{part:1,index:n}}}}for(var n=0;n<e.path.length;n++){if(e.path[(n+1)%e.path.length].arc&&!e.path[n%e.path.length].arc){var r=graphs.point(e.path[n%e.path.length].x,e.path[n%e.path.length].y);var i=graphs.point(e.path[(n+2)%e.path.length].x,e.path[(n+2)%e.path.length].y);var s=graphs.point(e.path[(n+1)%e.path.length].x,e.path[(n+1)%e.path.length].y);var o=graphs.intersection_2line(graphs.perpendicular_bisector(graphs.line(r,s)),graphs.perpendicular_bisector(graphs.line(i,s)));var u=graphs.length(o,s);var a=Math.atan2(r.y-o.y,r.x-o.x);var f=Math.atan2(i.y-o.y,i.x-o.x);var l=Math.atan2(s.y-o.y,s.x-o.x);var c=Math.atan2(t.y-o.y,t.x-o.x);if(Math.abs(graphs.length(o,t)-u)<8&&(f<l&&l<a||a<f&&f<l||l<a&&a<f)==(f<c&&c<a||a<f&&f<c||c<a&&a<f)){return{draggingPart:{part:0,mouse1:t}}}}else if(!e.path[(n+1)%e.path.length].arc&&!e.path[n%e.path.length].arc){if(mouseOnSegment(t,graphs.segment(e.path[n%e.path.length],e.path[(n+1)%e.path.length]))){return{draggingPart:{part:0,mouse1:t}}}}}},dragging:function(e,t,n){if(e.notDone){if(e.path[e.path.length-1].arc){e.path[e.path.length-1]={x:t.x,y:t.y,arc:true}}else{if(!mouseOnPoint(t,e.path[e.path.length-1])){e.path[e.path.length]={x:t.x,y:t.y,arc:true}}}return{obj:e}}if(n.part==1){e.path[n.index].x=t.x;e.path[n.index].y=t.y;return{obj:e}}if(n.part==0){return{obj:this.move(e,t.x-n.mouse1.x,t.y-n.mouse1.y),draggingPart:{part:0,mouse1:t}}}},rayIntersection:function(e,t){if(e.notDone){return}var n=Infinity;var r;var i=null;var s=null;for(var o=0;o<e.path.length;o++){s=null;if(e.path[(o+1)%e.path.length].arc&&!e.path[o%e.path.length].arc){var u=graphs.point(e.path[o%e.path.length].x,e.path[o%e.path.length].y);var a=graphs.point(e.path[(o+2)%e.path.length].x,e.path[(o+2)%e.path.length].y);var f=graphs.point(e.path[(o+1)%e.path.length].x,e.path[(o+1)%e.path.length].y);var l=graphs.intersection_2line(graphs.perpendicular_bisector(graphs.line(u,f)),graphs.perpendicular_bisector(graphs.line(a,f)));var c=graphs.length(l,f);var h=Math.atan2(u.y-l.y,u.x-l.x);var p=Math.atan2(a.y-l.y,a.x-l.x);var d=Math.atan2(f.y-l.y,f.x-l.x);var v=graphs.intersection_line_circle(graphs.line(t.p1,t.p2),graphs.circle(l,a));var m;var g=[];var y=[];for(var b=1;b<=2;b++){m=Math.atan2(v[b].y-l.y,v[b].x-l.x);g[b]=(p<d&&d<h||h<p&&p<d||d<h&&h<p)==(p<m&&m<h||h<p&&p<m||m<h&&h<p)&&graphs.length(v[b],t.p1)>graphs.length(v[b],t.p2);y[b]=graphs.length(t.p1,v[b])}if(g[1]&&(!g[2]||y[1]<y[2])){s=v[1];r=y[1]}if(g[2]&&(!g[1]||y[2]<y[1])){s=v[2];r=y[2]}}else if(!e.path[(o+1)%e.path.length].arc&&!e.path[o%e.path.length].arc){var v=graphs.intersection(graphs.line(t.p1,t.p2),graphs.line(e.path[o%e.path.length],e.path[(o+1)%e.path.length]));if(graphs.length(v,e.path[o%e.path.length])+graphs.length(v,e.path[(o+1)%e.path.length])-graphs.length(e.path[o%e.path.length],e.path[(o+1)%e.path.length])<1e-7&&(graphs.length(v,t.p1)+graphs.length(v,t.p2)-graphs.length_segment(t)<1e-7||graphs.length(v,t.p1)>graphs.length(v,t.p2))){r=graphs.length(t.p1,v);s=v}}if(s){if(r<n&&r>1e-5){n=r;i=s}}}if(i){return i}},shot:function(e,t){if(e.notDone){return}var n=Infinity;var r;var i=null;var s=null;var o;for(var u=0;u<e.path.length;u++){s=null;if(e.path[(u+1)%e.path.length].arc&&!e.path[u%e.path.length].arc){var a=graphs.point(e.path[u%e.path.length].x,e.path[u%e.path.length].y);var f=graphs.point(e.path[(u+2)%e.path.length].x,e.path[(u+2)%e.path.length].y);var l=graphs.point(e.path[(u+1)%e.path.length].x,e.path[(u+1)%e.path.length].y);var c=graphs.intersection_2line(graphs.perpendicular_bisector(graphs.line(a,l)),graphs.perpendicular_bisector(graphs.line(f,l)));var h=graphs.length(c,l);var p=Math.atan2(a.y-c.y,a.x-c.x);var d=Math.atan2(f.y-c.y,f.x-c.x);var v=Math.atan2(l.y-c.y,l.x-c.x);var m=graphs.intersection_line_circle(graphs.line(t.p1,t.p2),graphs.circle(c,f));var g;var y=[];var b=[];for(var w=1;w<=2;w++){g=Math.atan2(m[w].y-c.y,m[w].x-c.x);y[w]=(d<v&&v<p||p<d&&d<v||v<p&&p<d)==(d<g&&g<p||p<d&&d<g||g<p&&p<d)&&graphs.length(m[w],t.p1)>graphs.length(m[w],t.p2);b[w]=graphs.length(t.p1,m[w])}if(y[1]&&(!y[2]||b[1]<b[2])){s=m[1];r=b[1]}if(y[2]&&(!y[1]||b[2]<b[1])){s=m[2];r=b[2]}}else if(!e.path[(u+1)%e.path.length].arc&&!e.path[u%e.path.length].arc){var m=graphs.intersection(graphs.line(t.p1,t.p2),graphs.line(e.path[u%e.path.length],e.path[(u+1)%e.path.length]));if(graphs.length(m,e.path[u%e.path.length])+graphs.length(m,e.path[(u+1)%e.path.length])-graphs.length(e.path[u%e.path.length],e.path[(u+1)%e.path.length])<1e-7&&(graphs.length(m,t.p1)+graphs.length(m,t.p2)-graphs.length_segment(t)<1e-7||graphs.length(m,t.p1)>graphs.length(m,t.p2))){r=graphs.length(t.p1,m);s=m}}if(s){if(r<n&&r>1e-5){n=r;i=s;o=u}}}if(e.path[(o+1)%e.path.length].arc&&!e.path[o%e.path.length].arc){var a=graphs.point(e.path[o%e.path.length].x,e.path[o%e.path.length].y);var f=graphs.point(e.path[(o+2)%e.path.length].x,e.path[(o+2)%e.path.length].y);var l=graphs.point(e.path[(o+1)%e.path.length].x,e.path[(o+1)%e.path.length].y);var c=graphs.intersection_2line(graphs.perpendicular_bisector(graphs.line(a,l)),graphs.perpendicular_bisector(graphs.line(f,l)));var h=graphs.length(c,l);var p=Math.atan2(a.y-c.y,a.x-c.x);var d=Math.atan2(f.y-c.y,f.x-c.x);var v=Math.atan2(l.y-c.y,l.x-c.x);var E=d<v&&v<p||p<d&&d<v||v<p&&p<d;var S=Math.atan2(i.y-c.y,i.x-c.x)-Math.PI/2;if(S<=-Math.PI){S=S+Math.PI*2}var x=Math.atan2(t.p1.y-i.y,t.p1.x-i.x);var T=S>=0&&S>x&&x>S-Math.PI||S<0&&(x<S||x>S+Math.PI);if(T){var N=S-Math.PI/2}else{var N=S+Math.PI/2}if(T!=E){var C=e.p}else{var C=1/e.p}}else if(!e.path[(o+1)%e.path.length].arc&&!e.path[o%e.path.length].arc){var S=Math.atan2(e.path[o%e.path.length].y-e.path[(o+1)%e.path.length].y,e.path[o%e.path.length].x-e.path[(o+1)%e.path.length].x);var x=Math.atan2(t.p1.y-i.y,t.p1.x-i.x);if(S>=0&&S>x&&x>S-Math.PI||S<0&&(x<S||x>S+Math.PI)){var N=S-Math.PI/2;var C=e.p}else{var N=S+Math.PI/2;var C=1/e.p}}if(Math.abs(Math.sin(N-x)*C)>1){var k=N*2-x}else{var k=N+Math.PI-Math.asin(Math.sin(N-x)*C)}return graphs.ray(i,graphs.point(i.x+Math.cos(k),i.y+Math.sin(k)))}}
