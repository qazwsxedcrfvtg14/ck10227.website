<?php include("../../include.php"); ?>﻿


<html> <head> <title>光線模擬</title>
<script type='text/javascript'>
parent.document.getElementById('title').innerHTML=document.title;
</script> <meta http-equiv="content-type" content="text/html; charset=UTF-8"> 

<link rel="stylesheet" type="text/css" href="./BS.css">
<?php 
if(!$P_Light_Moni){
	echo"</head><body>你沒有權限</body></html>";
	return;
	}
?>
<script language="JavaScript" type="text/javascript">var H={aH:function(x,y){return{type:"aH",x:x,y:y,bA:true}},line:function(L,G){return{type:"line",L:L,G:G,bA:true}},l:function(L,G){return{type:"l",L:L,G:G,bA:true}},aX:function(L,G){return{type:"aX",L:L,G:G,bA:true}},ah:function(L,G){return{type:"aX",L:L,G:G,bA:true}},circle:function(c,r){if(typeof r=="object"&&r.type=="aH"){return{type:"circle",c:c,r:this.aX(c,r),bA:true}}else{return{type:"circle",c:c,r:r,bA:true}}},bG:function(bN,aA){if(bN.type=="line"&&aA.type=="line"){return this.aZ(bN,aA)}if(bN.type=="line"&&aA.type=="circle"){return this.aK(bN,aA)}if(bN.type=="circle"&&aA.type=="line"){return this.aK(aA,bN)}if(bN.type=="circle"&&aA.type=="circle"){return this.bF(bN,aA)}},aZ:function(aM,bq){var a,b,c,d,x,y;if(Math.abs(aM.G.x-aM.L.x)<1e-8){b=aM.L.x;c=(bq.G.y-bq.L.y)/(bq.G.x-bq.L.x);d=bq.L.y-c*(bq.L.x);x=b;y=c*b+d}if(Math.abs(bq.G.x-bq.L.x)<1e-8){a=(aM.G.y-aM.L.y)/(aM.G.x-aM.L.x);b=aM.L.y-a*(aM.L.x);d=bq.L.x;x=d;y=a*d+b}if(!(Math.abs(aM.G.x-aM.L.x)<1e-8)&& !(Math.abs(bq.G.x-bq.L.x)<1e-8)){a=(aM.G.y-aM.L.y)/(aM.G.x-aM.L.x);b=aM.L.y-a*(aM.L.x);c=(bq.G.y-bq.L.y)/(bq.G.x-bq.L.x);d=bq.L.y-c*(bq.L.x);x=(d-b)/(a-c);y=a*x+b}return H.aH(x,y)},aK:function(aM,aw){var a,b,c,d,e,A,B,C;var x=new Array();var y=new Array();var p=new Array();if(Math.abs(aM.G.x-aM.L.x)<1e-8){b=aM.L.x;c=aw.c.x;d=aw.c.y;e=(typeof aw.r=="object")?(Math.sqrt(Math.pow(aw.r.L.x-aw.r.G.x,2)+Math.pow(aw.r.L.y-aw.r.G.y,2))):(aw.r);x[1]=b;x[2]=b;y[1]=(2*d+Math.sqrt(Math.pow(2*d,2)-4*(Math.pow(x[1]-c,2)+Math.pow(d,2)-Math.pow(e,2))))/2;y[2]=(2*d-Math.sqrt(Math.pow(2*d,2)-4*(Math.pow(x[2]-c,2)+Math.pow(d,2)-Math.pow(e,2))))/2}else{a=(aM.G.y-aM.L.y)/(aM.G.x-aM.L.x);b=aM.L.y-a*(aM.L.x);c=aw.c.x;d=aw.c.y;e=(typeof aw.r=="object")?(Math.sqrt(Math.pow(aw.r.L.x-aw.r.G.x,2)+Math.pow(aw.r.L.y-aw.r.G.y,2))):(aw.r);A=1+Math.pow(a,2);B= -2*c+2*a*b-2*d*a;C=Math.pow(c,2)+Math.pow(b,2)-2*d*b+Math.pow(d,2)-Math.pow(e,2);x[1]=(-B+Math.sqrt(Math.pow(B,2)-4*A*C))/(2*A);x[2]=(-B-Math.sqrt(Math.pow(B,2)-4*A*C))/(2*A);y[1]=a*x[1]+b;y[2]=a*x[2]+b}p[1]=H.aH(x[1],y[1]);p[2]=H.aH(x[2],y[2]);return p},bF:function(aw,ac){var a,b,c,d,e,f,A,B,C,D,E;var x=new Array();var y=new Array();var p=new Array();a=aw.c.x;b=aw.c.y;c=(typeof aw.r=="object")?(Math.sqrt(Math.pow(aw.r.L.x-aw.r.G.x,2)+Math.pow(aw.r.L.y-aw.r.G.y,2))):(aw.r);d=ac.c.x;e=ac.c.y;f=(typeof ac.r=="object")?(Math.sqrt(Math.pow(ac.r.L.x-ac.r.G.x,2)+Math.pow(ac.r.L.y-ac.r.G.y,2))):(ac.r);A=(2*e-2*b)/(2*d-2*a);B=(-Math.pow(a,2)-Math.pow(b,2)+Math.pow(c,2)+Math.pow(d,2)+Math.pow(e,2)-Math.pow(f,2))/(2*d-2*a);if(Math.abs(d-a)<1e-8){A=(Math.pow(a,2)+Math.pow(b,2)-Math.pow(c,2)-Math.pow(d,2)-Math.pow(e,2)+Math.pow(f,2))/(2*e-2*b);C=1;D= -2*a;E=Math.pow(A,2)+2*b*A+Math.pow(a,2)+Math.pow(b,2)-Math.pow(c,2);y[1]= -A;y[2]= -A;x[1]=(-D+Math.sqrt(Math.pow(D,2)-4*C*E))/(2*C);x[2]=(-D-Math.sqrt(Math.pow(D,2)-4*C*E))/(2*C)}else{A=(2*e-2*b)/(2*d-2*a);B=(-Math.pow(a,2)-Math.pow(b,2)+Math.pow(c,2)+Math.pow(d,2)+Math.pow(e,2)-Math.pow(f,2))/(2*d-2*a);C=Math.pow(A,2)+1;D=2*(-A)*B-2*a*(-A)-2*b;E=Math.pow(B,2)-2*a*B+Math.pow(a,2)+Math.pow(b,2)-Math.pow(c,2);y[1]=(-D+Math.sqrt(Math.pow(D,2)-4*C*E))/(2*C);y[2]=(-D-Math.sqrt(Math.pow(D,2)-4*C*E))/(2*C);x[1]=(-A)*y[1]+B;x[2]=(-A)*y[2]+B}p[1]=H.aH(x[1],y[1]);p[2]=H.aH(x[2],y[2]);return p},ao:function(aQ){return Math.sqrt(Math.pow(aQ.L.x-aQ.G.x,2)+Math.pow(aQ.L.y-aQ.G.y,2))},length:function(L,G){return Math.sqrt(Math.pow(L.x-G.x,2)+Math.pow(L.y-G.y,2))},co:function(aM){var aU=H.bF(H.circle(aM.L,aM.G),H.circle(aM.G,aM.L));return H.aZ(aM,H.line(aU[1],aU[2]))},aq:function(aM){var aU=H.bF(H.circle(aM.L,aM.G),H.circle(aM.G,aM.L));return H.line(aU[1],aU[2])},aa:function(aM,L){var aw=H.circle(aM.L,L);var B=H.bG(aM,aw)[1];var ac=H.circle(B,aM.L);var bW=H.circle(L,aM.L);var aD=H.bG(ac,bW);if(Math.abs(aD[2].x-aM.L.x)<1e-5&&Math.abs(aD[2].y-aM.L.y)<1e-5){return H.line(aD[1],L)}else{return H.line(aD[2],L)}}};var bO={aY:function(aG,canvas,color){var h=canvas.getContext('2d');if(aG.type=="aH"){if(typeof color=="undefined"){h.fillStyle="red"}else{h.fillStyle=color}h.fillRect(aG.x-2,aG.y-2,5,5)}if(aG.type=="line"){if(typeof color=="undefined"){h.strokeStyle="black"}else{h.strokeStyle=color}h.beginPath();ar=Math.atan2((aG.G.x-aG.L.x),(aG.G.y-aG.L.y));bm=Math.abs(aG.L.x)+Math.abs(aG.L.y)+canvas.height+canvas.width;h.moveTo(aG.L.x-Math.sin(ar)*bm,aG.L.y-Math.cos(ar)*bm);h.lineTo(aG.L.x+Math.sin(ar)*bm,aG.L.y+Math.cos(ar)*bm);h.stroke();}if(aG.type=="l"){if(typeof color=="undefined"){h.strokeStyle="black"}else{h.strokeStyle=color}var ar,bm;h.beginPath();ar=Math.atan2((aG.G.x-aG.L.x),(aG.G.y-aG.L.y));bm=Math.abs(aG.L.x)+Math.abs(aG.L.y)+canvas.height+canvas.width;h.moveTo(aG.L.x,aG.L.y);h.lineTo(aG.L.x+Math.sin(ar)*bm,aG.L.y+Math.cos(ar)*bm);h.stroke();}if(aG.type=="aX"){if(typeof color=="undefined"){h.strokeStyle="black"}else{h.strokeStyle=color}h.beginPath();h.moveTo(aG.L.x,aG.L.y);h.lineTo(aG.G.x,aG.G.y);h.stroke();}if(aG.type=="circle"){if(typeof color=="undefined"){h.strokeStyle="black"}else{h.strokeStyle=color}h.beginPath();if(typeof aG.r=="object"){h.arc(aG.c.x,aG.c.y,Math.sqrt(Math.pow(aG.r.L.x-aG.r.G.x,2)+Math.pow(aG.r.L.y-aG.r.G.y,2)),0,Math.PI*2,false);}else{h.arc(aG.c.x,aG.c.y,aG.r,0,Math.PI*2,false);}h.stroke();}},cU:function(canvas){var h=canvas.getContext('2d');h.clearRect(0,0,canvas.width,canvas.height);}};var bV={};bV["refractor"]={bx:"折射率",create:function(K){return{R:{type:"refractor",path:[{x:K.x,y:K.y,arc:false}],av:true,p:1.2},O:{}};},aY:function(R,canvas){var h=canvas.getContext('2d');for(var i=0;i<R.path.length;i++){if(R.path[i].arc){h.fillStyle="rgb(255,0,255)";h.fillRect(R.path[i].x-3,R.path[i].y-3,5,5);}else{h.fillStyle="rgb(255,0,0)";h.fillRect(R.path[i].x-3,R.path[i].y-3,5,5);}}if(!R.av){h.beginPath();h.moveTo(R.path[0].x,R.path[0].y);for(var i=0;i<R.path.length;i++){if(R.path[(i+1)%R.path.length].arc&& !R.path[i%R.path.length].arc){var L=H.aH(R.path[i%R.path.length].x,R.path[i%R.path.length].y);var G=H.aH(R.path[(i+2)%R.path.length].x,R.path[(i+2)%R.path.length].y);var F=H.aH(R.path[(i+1)%R.path.length].x,R.path[(i+1)%R.path.length].y);var center=H.aZ(H.aq(H.line(L,F)),H.aq(H.line(G,F)));var r=H.length(center,F);var V=Math.atan2(L.y-center.y,L.x-center.x);var v=Math.atan2(G.y-center.y,G.x-center.x);var t=Math.atan2(F.y-center.y,F.x-center.x);var bf=(v<t&&t<V)||(V<v&&v<t)||(t<V&&V<v);h.arc(center.x,center.y,r,V,v,bf);}else if(!R.path[(i+1)%R.path.length].arc&& !R.path[i%R.path.length].arc){h.lineTo(R.path[(i+1)%R.path.length].x,R.path[(i+1)%R.path.length].y);}}h.fillStyle="rgb(255,255,0)";h.globalAlpha=1-1/R.p;h.fill();h.globalAlpha=1;h.strokeStyle="rgb(0,0,0)";h.lineWidth=1;h.stroke();}},move:function(R,aL,bk){for(var i=0;i<R.path.length;i++){R.path[i].x+=aL;R.path[i].y+=bk}return R;},ae:function(R,K){if(R.av){if(bQ(K,R.path[0])){R.av=false;return{R:R};}else{R.path[R.path.length]={x:K.x,y:K.y,arc:false};}return{R:R,O:{}};}for(var i=0;i<R.path.length;i++){if(bQ(K,R.path[i])){return{O:{J:1,index:i}};}}for(var i=0;i<R.path.length;i++){if(R.path[(i+1)%R.path.length].arc&& !R.path[i%R.path.length].arc){var L=H.aH(R.path[i%R.path.length].x,R.path[i%R.path.length].y);var G=H.aH(R.path[(i+2)%R.path.length].x,R.path[(i+2)%R.path.length].y);var F=H.aH(R.path[(i+1)%R.path.length].x,R.path[(i+1)%R.path.length].y);var center=H.aZ(H.aq(H.line(L,F)),H.aq(H.line(G,F)));var r=H.length(center,F);var V=Math.atan2(L.y-center.y,L.x-center.x);var v=Math.atan2(G.y-center.y,G.x-center.x);var t=Math.atan2(F.y-center.y,F.x-center.x);var an=Math.atan2(K.y-center.y,K.x-center.x);if(Math.abs(H.length(center,K)-r)<8&&(((v<t&&t<V)||(V<v&&v<t)||(t<V&&V<v))==((v<an&&an<V)||(V<v&&v<an)||(an<V&&V<v)))){return{O:{J:0,bz:K}};}}else if(!R.path[(i+1)%R.path.length].arc&& !R.path[i%R.path.length].arc){if(bj(K,H.ah(R.path[(i)%R.path.length],R.path[(i+1)%R.path.length]))){return{O:{J:0,bz:K}};}}}},dragging:function(R,K,O){if(R.av){if(R.path[R.path.length-1].arc){R.path[R.path.length-1]={x:K.x,y:K.y,arc:true};}else{if(!bQ(K,R.path[R.path.length-1])){R.path[R.path.length]={x:K.x,y:K.y,arc:true};}}return{R:R};}if(O.J==1){R.path[O.index].x=K.x;R.path[O.index].y=K.y;return{R:R};}if(O.J==0){return{R:this.move(R,K.x-O.bz.x,K.y-O.bz.y),O:{J:0,bz:K}};}},be:function(R,l){if(R.av){return;}var bb=Infinity;var au;var aJ=null;var bs=null;for(var i=0;i<R.path.length;i++){bs=null;if(R.path[(i+1)%R.path.length].arc&& !R.path[i%R.path.length].arc){var L=H.aH(R.path[i%R.path.length].x,R.path[i%R.path.length].y);var G=H.aH(R.path[(i+2)%R.path.length].x,R.path[(i+2)%R.path.length].y);var F=H.aH(R.path[(i+1)%R.path.length].x,R.path[(i+1)%R.path.length].y);var center=H.aZ(H.aq(H.line(L,F)),H.aq(H.line(G,F)));var r=H.length(center,F);var V=Math.atan2(L.y-center.y,L.x-center.x);var v=Math.atan2(G.y-center.y,G.x-center.x);var t=Math.atan2(F.y-center.y,F.x-center.x);var T=H.aK(H.line(l.L,l.G),H.circle(center,G));var bp;var aF=[];var ag=[];for(var aW=1;aW<=2;aW++){bp=Math.atan2(T[aW].y-center.y,T[aW].x-center.x);aF[aW]=(((v<t&&t<V)||(V<v&&v<t)||(t<V&&V<v))==((v<bp&&bp<V)||(V<v&&v<bp)||(bp<V&&V<v)))&&((H.length(T[aW],l.L)>H.length(T[aW],l.G)));ag[aW]=H.length(l.L,T[aW])}if(aF[1]&&((!aF[2])||ag[1]<ag[2])){bs=T[1];au=ag[1];}if(aF[2]&&((!aF[1])||ag[2]<ag[1])){bs=T[2];au=ag[2];}}else if(!R.path[(i+1)%R.path.length].arc&& !R.path[i%R.path.length].arc){var T=H.bG(H.line(l.L,l.G),H.line(R.path[i%R.path.length],R.path[(i+1)%R.path.length]));if((H.length(T,R.path[i%R.path.length])+H.length(T,R.path[(i+1)%R.path.length])-H.length(R.path[i%R.path.length],R.path[(i+1)%R.path.length])<1e-7)&&((H.length(T,l.L)+H.length(T,l.G)-H.ao(l)<1e-7)||(H.length(T,l.L)>H.length(T,l.G)))){au=H.length(l.L,T);bs=T;}}if(bs){if(au<bb&&au>1e-5){bb=au;aJ=bs;}}}if(aJ){return aJ;}},aS:function(R,l){if(R.av){return;}var bb=Infinity;var au;var aJ=null;var bs=null;var ax;for(var i=0;i<R.path.length;i++){bs=null;if(R.path[(i+1)%R.path.length].arc&& !R.path[i%R.path.length].arc){var L=H.aH(R.path[i%R.path.length].x,R.path[i%R.path.length].y);var G=H.aH(R.path[(i+2)%R.path.length].x,R.path[(i+2)%R.path.length].y);var F=H.aH(R.path[(i+1)%R.path.length].x,R.path[(i+1)%R.path.length].y);var center=H.aZ(H.aq(H.line(L,F)),H.aq(H.line(G,F)));var r=H.length(center,F);var V=Math.atan2(L.y-center.y,L.x-center.x);var v=Math.atan2(G.y-center.y,G.x-center.x);var t=Math.atan2(F.y-center.y,F.x-center.x);var T=H.aK(H.line(l.L,l.G),H.circle(center,G));var bp;var aF=[];var ag=[];for(var aW=1;aW<=2;aW++){bp=Math.atan2(T[aW].y-center.y,T[aW].x-center.x);aF[aW]=(((v<t&&t<V)||(V<v&&v<t)||(t<V&&V<v))==((v<bp&&bp<V)||(V<v&&v<bp)||(bp<V&&V<v)))&&((H.length(T[aW],l.L)>H.length(T[aW],l.G)));ag[aW]=H.length(l.L,T[aW])}if(aF[1]&&((!aF[2])||ag[1]<ag[2])){bs=T[1];au=ag[1];}if(aF[2]&&((!aF[1])||ag[2]<ag[1])){bs=T[2];au=ag[2];}}else if(!R.path[(i+1)%R.path.length].arc&& !R.path[i%R.path.length].arc){var T=H.bG(H.line(l.L,l.G),H.line(R.path[i%R.path.length],R.path[(i+1)%R.path.length]));if((H.length(T,R.path[i%R.path.length])+H.length(T,R.path[(i+1)%R.path.length])-H.length(R.path[i%R.path.length],R.path[(i+1)%R.path.length])<1e-7)&&((H.length(T,l.L)+H.length(T,l.G)-H.ao(l)<1e-7)||(H.length(T,l.L)>H.length(T,l.G)))){au=H.length(l.L,T);bs=T;}}if(bs){if(au<bb&&au>1e-5){bb=au;aJ=bs;ax=i;}}}if(R.path[(ax+1)%R.path.length].arc&& !R.path[ax%R.path.length].arc){var L=H.aH(R.path[ax%R.path.length].x,R.path[ax%R.path.length].y);var G=H.aH(R.path[(ax+2)%R.path.length].x,R.path[(ax+2)%R.path.length].y);var F=H.aH(R.path[(ax+1)%R.path.length].x,R.path[(ax+1)%R.path.length].y);var center=H.aZ(H.aq(H.line(L,F)),H.aq(H.line(G,F)));var r=H.length(center,F);var V=Math.atan2(L.y-center.y,L.x-center.x);var v=Math.atan2(G.y-center.y,G.x-center.x);var t=Math.atan2(F.y-center.y,F.x-center.x);var bf=(v<t&&t<V)||(V<v&&v<t)||(t<V&&V<v);var aO=Math.atan2(aJ.y-center.y,aJ.x-center.x)-Math.PI/2;if(aO<= -Math.PI){aO=aO+Math.PI*2;}var ad=Math.atan2(l.L.y-aJ.y,l.L.x-aJ.x);var ai=(aO>=0&&aO>ad&&ad>(aO-Math.PI))||(aO<0&&(ad<aO||ad>(aO+Math.PI)));if(ai){var bw=aO-Math.PI/2}else{var bw=aO+Math.PI/2}if(ai!=bf){var p=R.p;}else{var p=1/R.p;}}else if(!R.path[(ax+1)%R.path.length].arc&& !R.path[ax%R.path.length].arc){var aO=Math.atan2(R.path[ax%R.path.length].y-R.path[(ax+1)%R.path.length].y,R.path[ax%R.path.length].x-R.path[(ax+1)%R.path.length].x);var ad=Math.atan2(l.L.y-aJ.y,l.L.x-aJ.x);if((aO>=0&&aO>ad&&ad>(aO-Math.PI))||(aO<0&&(ad<aO||ad>(aO+Math.PI)))){var bw=aO-Math.PI/2;var p=R.p;}else{var bw=aO+Math.PI/2;var p=1/R.p;}}if(Math.abs(Math.sin(bw-ad)*p)>1){var bd=bw*2-ad}else{var bd=bw+Math.PI-Math.asin(Math.sin(bw-ad)*p);}return H.l(aJ,H.aH(aJ.x+Math.cos(bd),aJ.y+Math.sin(bd)));}};bV["laser"]={create:function(K){return{R:{type:"laser",L:K,G:H.aH(K.x+al,K.y)},O:{J:2}};},aY:function(R,canvas){var h=canvas.getContext('2d');h.fillStyle="rgb(255,0,0)";h.fillRect(R.L.x-2,R.L.y-2,5,5);h.fillRect(R.G.x-2,R.G.y-2,3,3)},move:function(R,aL,bk){R.L.x=R.L.x+aL;R.L.y=R.L.y+bk;R.G.x=R.G.x+aL;R.G.y=R.G.y+bk;return R;},ae:function(R,K){if(bQ(K,R.L)){return{O:{J:1}};}if(bQ(K,R.G)){return{O:{J:2}};}if(bj(K,R)){return{O:{J:0,bz:K}};}return false;},dragging:function(R,K,O){if(O.J==1){R.L=K;return{R:R}}if(O.J==2){R.G=K;return{R:R}}if(O.J==0){var by=O.bz.x-K.x;var aC=O.bz.y-K.y;R.L.x=R.L.x-by;R.L.y=R.L.y-aC;R.G.x=R.G.x-by;R.G.y=R.G.y-aC;return{R:R,O:{J:0,bz:K}}}},bD:function(R){bK(H.l(R.L,R.G))}};bV["ba"]={create:function(K){return{R:{type:"ba",L:K,G:H.aH(K.x+al,K.y)},O:{J:2}};},aY:function(R,canvas){var h=canvas.getContext('2d');h.strokeStyle="rgb(192,192,192)";h.beginPath();h.moveTo(R.L.x,R.L.y);h.lineTo(R.G.x,R.G.y);h.stroke();},move:function(R,aL,bk){R.L.x=R.L.x+aL;R.L.y=R.L.y+bk;R.G.x=R.G.x+aL;R.G.y=R.G.y+bk;return R;},ae:function(R,K){if(bQ(K,R.L)){return{O:{J:1}};}if(bQ(K,R.G)){return{O:{J:2}};}if(bj(K,R)){return{O:{J:0,bz:K}};}return false;},dragging:function(R,K,O){if(O.J==1){R.L=K;return{R:R}}if(O.J==2){R.G=K;return{R:R}}if(O.J==0){var by=O.bz.x-K.x;var aC=O.bz.y-K.y;R.L.x=R.L.x-by;R.L.y=R.L.y-aC;R.G.x=R.G.x-by;R.G.y=R.G.y-aC;return{R:R,O:{J:0,bz:K}}}},be:function(ba,l){var T=H.bG(H.line(l.L,l.G),H.line(ba.L,ba.G));if((H.ao(H.ah(T,ba.L))+H.ao(H.ah(T,ba.G))-H.ao(ba)<1e-7)&&((H.ao(H.ah(T,l.L))+H.ao(H.ah(T,l.G))-H.ao(l)<1e-7)||(H.ao(H.ah(T,l.L))>H.ao(H.ah(T,l.G))))){return T;}},aS:function(ba,l){var rp=H.bG(H.line(l.L,l.G),H.line(ba.L,ba.G));var bH=2*(Math.atan2(ba.G.x-ba.L.x,ba.G.y-ba.L.y)+Math.PI/2)-Math.atan2(l.G.x-l.L.x,l.G.y-l.L.y);var aR=H.l(rp,H.aH(rp.x-Math.sin(bH),rp.y-Math.cos(bH)));return aR;}};bV["bv"]={bx:"焦距(px)",create:function(K){return{R:{type:"bv",L:K,G:H.aH(K.x+al,K.y),p:100},O:{J:2}};},aY:function(R,canvas){var h=canvas.getContext('2d');h.strokeStyle="rgba(192,192,192,0.5)";h.lineWidth=5;h.lineCap="round";h.beginPath();h.moveTo(R.L.x,R.L.y);h.lineTo(R.G.x,R.G.y);h.stroke();h.lineWidth=1;h.lineCap="butt"},move:function(R,aL,bk){R.L.x=R.L.x+aL;R.L.y=R.L.y+bk;R.G.x=R.G.x+aL;R.G.y=R.G.y+bk;return R;},ae:function(R,K){if(bQ(K,R.L)){return{O:{J:1}};}if(bQ(K,R.G)){return{O:{J:2}};}if(bj(K,R)){return{O:{J:0,bz:K}};}return false;},dragging:function(R,K,O){if(O.J==1){R.L=K;return{R:R}}if(O.J==2){R.G=K;return{R:R}}if(O.J==0){var by=O.bz.x-K.x;var aC=O.bz.y-K.y;R.L.x=R.L.x-by;R.L.y=R.L.y-aC;R.G.x=R.G.x-by;R.G.y=R.G.y-aC;return{R:R,O:{J:0,bz:K}}}},be:function(bv,l){var T=H.bG(H.line(l.L,l.G),H.line(bv.L,bv.G));if((H.ao(H.ah(T,bv.L))+H.ao(H.ah(T,bv.G))-H.ao(bv)<1e-7)&&((H.ao(H.ah(T,l.L))+H.ao(H.ah(T,l.G))-H.ao(l)<1e-7)||(H.ao(H.ah(T,l.L))>H.ao(H.ah(T,l.G))))){return T;}},aS:function(bv,l){var ak=H.bG(H.line(l.L,l.G),H.line(bv.L,bv.G));var cC=H.aq(bv);var dc=H.co(bv);var bu=H.bG(cC,H.aa(H.line(bv.L,bv.G),l.L));var p=H.length(bu,dc);var q=(p*bv.p)/(p-bv.p);var bo=(q*H.length(bu,l.L))/p;var bc=H.bG(cC,H.circle(dc,Math.abs(q)));var cj=((q>0)==(H.length(bc[1],bu)<H.length(bc[2],bu)))?bc[2]:bc[1];var af=H.bG(H.aa(H.line(bv.L,bv.G),cj),H.circle(cj,Math.abs(bo)));var bI=H.line(ak,((bo>0)==(H.length(af[1],l.L)>H.length(af[2],l.L)))?af[1]:af[2]);var ar=Math.atan2((bI.G.x-bI.L.x),(bI.G.y-bI.L.y));return(q>0)?H.l(ak,H.aH(bI.L.x+Math.sin(ar),bI.L.y+Math.cos(ar))):H.l(ak,H.aH(bI.L.x-Math.sin(ar),bI.L.y-Math.cos(ar)));}};bV["blackline"]={create:function(K){return{R:{type:"blackline",L:K,G:H.aH(K.x+al,K.y)},O:{J:2}};},aY:function(R,canvas){var h=canvas.getContext('2d');h.strokeStyle="rgb(0,0,0)";h.beginPath();h.moveTo(R.L.x,R.L.y);h.lineTo(R.G.x,R.G.y);h.stroke();},move:function(R,aL,bk){R.L.x=R.L.x+aL;R.L.y=R.L.y+bk;R.G.x=R.G.x+aL;R.G.y=R.G.y+bk;return R;},ae:function(R,K){if(bQ(K,R.L)){return{O:{J:1}};}if(bQ(K,R.G)){return{O:{J:2}};}if(bj(K,R)){return{O:{J:0,bz:K}};}return false;},dragging:function(R,K,O){if(O.J==1){R.L=K;return{R:R}}if(O.J==2){R.G=K;return{R:R}}if(O.J==0){var by=O.bz.x-K.x;var aC=O.bz.y-K.y;R.L.x=R.L.x-by;R.L.y=R.L.y-aC;R.G.x=R.G.x-by;R.G.y=R.G.y-aC;return{R:R,O:{J:0,bz:K}}}},be:function(R,l){var T=H.bG(H.line(l.L,l.G),H.line(R.L,R.G));if((H.ao(H.ah(T,R.L))+H.ao(H.ah(T,R.G))-H.ao(R)<1e-7)&&((H.ao(H.ah(T,l.L))+H.ao(H.ah(T,l.G))-H.ao(l)<1e-7)||(H.ao(H.ah(T,l.L))>H.ao(H.ah(T,l.G))))){return T;}},aS:function(R,l){}};bV["radiant"]={bx:"光線數量",create:function(K){return{R:{type:"radiant",x:K.x,y:K.y,p:500}};},aY:function(R,canvas){var h=canvas.getContext('2d');h.fillStyle="rgb(0,255,0)";h.fillRect(R.x-2,R.y-2,5,5)},move:function(R,aL,bk){R.x=R.x+aL;R.y=R.y+bk;return R;},ae:function(R,K){if(bQ(K,R)){return{O:{}};}return false;},dragging:function(R,K,O){R.x=K.x;R.y=K.y;return{R:R}},bD:function(R){var s=Math.PI*2/parseInt(R.p);for(var i=0;i<Math.PI*2;i=i+s)bK(H.l(H.aH(R.x,R.y),H.aH(R.x+Math.sin(i),R.y+Math.cos(i))))}};bV["aa"]={bx:"光線密度(1/px)",create:function(K){return{R:{type:"aa",L:K,G:H.aH(K.x+al,K.y),p:1},O:{J:2}};},aY:function(R,canvas){var h=canvas.getContext('2d');h.strokeStyle="rgb(0,255,0)";h.beginPath();h.moveTo(R.L.x,R.L.y);h.lineTo(R.G.x,R.G.y);h.stroke();},move:function(R,aL,bk){R.L.x=R.L.x+aL;R.L.y=R.L.y+bk;R.G.x=R.G.x+aL;R.G.y=R.G.y+bk;return R;},ae:function(R,K){if(bQ(K,R.L)){return{O:{J:1}};}if(bQ(K,R.G)){return{O:{J:2}};}if(bj(K,R)){return{O:{J:0,bz:K}};}return false;},dragging:function(R,K,O){if(O.J==1){R.L=K;return{R:R}}if(O.J==2){R.G=K;return{R:R}}if(O.J==0){var by=O.bz.x-K.x;var aC=O.bz.y-K.y;R.L.x=R.L.x-by;R.L.y=R.L.y-aC;R.G.x=R.G.x-by;R.G.y=R.G.y-aC;return{R:R,O:{J:0,bz:K}}}},bD:function(R){var a=Math.atan2(R.L.x-R.G.x,R.L.y-R.G.y)-Math.PI/2;var n=H.ao(R)*R.p;var cl=(R.G.x-R.L.x)/n;var cw=(R.G.y-R.L.y)/n;for(i=0;i<=n;i++){x=R.L.x+i*cl;y=R.L.y+i*cw;bK(H.l(H.aH(x,y),H.aH(x+Math.sin(a),y+Math.cos(a))))}}};bV["arcmirror"]={create:function(K){return{R:{type:"arcmirror",L:K,G:H.aH(K.x+al,K.y)},O:{J:2}};},aY:function(R,canvas){var h=canvas.getContext('2d');h.fillStyle="rgb(255,0,255)";if(R.F){var center=H.aZ(H.aq(H.line(R.L,R.F)),H.aq(H.line(R.G,R.F)));var r=H.length(center,R.F);var V=Math.atan2(R.L.y-center.y,R.L.x-center.x);var v=Math.atan2(R.G.y-center.y,R.G.x-center.x);var t=Math.atan2(R.F.y-center.y,R.F.x-center.x);h.strokeStyle="rgb(192,192,192)";h.beginPath();h.arc(center.x,center.y,r,V,v,(v<t&&t<V)||(V<v&&v<t)||(t<V&&V<v));h.stroke();h.fillRect(R.F.x-2,R.F.y-2,3,3);}h.fillStyle="rgb(255,0,0)";h.fillRect(R.L.x-2,R.L.y-2,3,3);h.fillRect(R.G.x-2,R.G.y-2,3,3);},move:function(R,aL,bk){R.L.x=R.L.x+aL;R.L.y=R.L.y+bk;R.G.x=R.G.x+aL;R.G.y=R.G.y+bk;R.F.x=R.F.x+aL;R.F.y=R.F.y+bk;return R;},ae:function(R,K){if(!R.F){R.F=K;return{R:R,O:{J:3}};}if(bQ(K,R.L)){return{O:{J:1}};}if(bQ(K,R.G)){return{O:{J:2}};}if(bQ(K,R.F)){return{O:{J:3}};}var center=H.aZ(H.aq(H.line(R.L,R.F)),H.aq(H.line(R.G,R.F)));var r=H.length(center,R.F);var V=Math.atan2(R.L.y-center.y,R.L.x-center.x);var v=Math.atan2(R.G.y-center.y,R.G.x-center.x);var t=Math.atan2(R.F.y-center.y,R.F.x-center.x);var an=Math.atan2(K.y-center.y,K.x-center.x);if(Math.abs(H.length(center,K)-r)<8&&(((v<t&&t<V)||(V<v&&v<t)||(t<V&&V<v))==((v<an&&an<V)||(V<v&&v<an)||(an<V&&V<v)))){return{O:{J:0,bz:K}};}return false;},dragging:function(R,K,O){if(O.J==1){R.L=K;return{R:R}}if(O.J==2){R.G=K;return{R:R}}if(O.J==3){R.F=K;return{R:R}}if(O.J==0){var by=O.bz.x-K.x;var aC=O.bz.y-K.y;R.L.x=R.L.x-by;R.L.y=R.L.y-aC;R.G.x=R.G.x-by;R.G.y=R.G.y-aC;R.F.x=R.F.x-by;R.F.y=R.F.y-aC;return{R:R,O:{J:0,bz:K}}}},be:function(R,l){if(!R.F){return;}var center=H.aZ(H.aq(H.line(R.L,R.F)),H.aq(H.line(R.G,R.F)));var r=H.length(center,R.F);var V=Math.atan2(R.L.y-center.y,R.L.x-center.x);var v=Math.atan2(R.G.y-center.y,R.G.x-center.x);var t=Math.atan2(R.F.y-center.y,R.F.x-center.x);var T=H.aK(H.line(l.L,l.G),H.circle(center,R.G));var bp;var aF=[];var ag=[];for(var i=1;i<=2;i++){bp=Math.atan2(T[i].y-center.y,T[i].x-center.x);aF[i]=(((v<t&&t<V)||(V<v&&v<t)||(t<V&&V<v))==((v<bp&&bp<V)||(V<v&&v<bp)||(bp<V&&V<v)))&&((H.length(T[i],l.L)>H.length(T[i],l.G)));ag[i]=H.length(l.L,T[i])}if(aF[1]&&((!aF[2])||ag[1]<ag[2])){return T[1];}if(aF[2]&&((!aF[1])||ag[2]<ag[1])){return T[2];}},aS:function(R,l){var center=H.aZ(H.aq(H.line(R.L,R.F)),H.aq(H.line(R.G,R.F)));var rp=this.be(R,l);var bH=2*(-Math.atan2(center.y-rp.y,center.x-rp.x)+Math.PI/2)-Math.atan2(l.G.x-l.L.x,l.G.y-l.L.y);var aR=H.l(rp,H.aH(rp.x-Math.sin(bH),rp.y-Math.cos(bH)));return aR;}};bV["interface"]={bx:"折射率",create:function(K){return{R:{type:"interface",L:K,G:H.aH(K.x+al,K.y),p:1.2},O:{J:2}};},aY:function(R,canvas){var h=canvas.getContext('2d');var bn=Math.atan2(R.L.x-R.G.x,R.L.y-R.G.y)-Math.PI/2;var bJ=Math.atan2(R.L.x-R.G.x,R.L.y-R.G.y)+Math.PI/2;h.strokeStyle="rgba(192,192,192,0.5)";h.lineWidth=4;h.lineCap="butt";h.beginPath();h.moveTo(R.L.x+Math.sin(bn)*2,R.L.y+Math.cos(bn)*2);h.lineTo(R.G.x+Math.sin(bn)*2,R.G.y+Math.cos(bn)*2);h.stroke();h.strokeStyle="rgba(128,128,255,0.5)";h.lineWidth=4;h.beginPath();h.moveTo(R.L.x+Math.sin(bJ)*2,R.L.y+Math.cos(bJ)*2);h.lineTo(R.G.x+Math.sin(bJ)*2,R.G.y+Math.cos(bJ)*2);h.stroke();h.strokeStyle="rgba(0,0,0,255)";h.lineWidth=0.5;h.beginPath();h.moveTo(R.L.x,R.L.y);h.lineTo(R.G.x,R.G.y);h.stroke();h.lineWidth=1;h.lineCap="butt"},move:function(R,aL,bk){R.L.x=R.L.x+aL;R.L.y=R.L.y+bk;R.G.x=R.G.x+aL;R.G.y=R.G.y+bk;return R;},ae:function(R,K){if(bQ(K,R.L)){return{O:{J:1}};}if(bQ(K,R.G)){return{O:{J:2}};}if(bj(K,R)){return{O:{J:0,bz:K}};}return false;},dragging:function(R,K,O){if(O.J==1){R.L=K;return{R:R}}if(O.J==2){R.G=K;return{R:R}}if(O.J==0){var by=O.bz.x-K.x;var aC=O.bz.y-K.y;R.L.x=R.L.x-by;R.L.y=R.L.y-aC;R.G.x=R.G.x-by;R.G.y=R.G.y-aC;return{R:R,O:{J:0,bz:K}}}},be:function(R,l){var T=H.bG(H.line(l.L,l.G),H.line(R.L,R.G));if((H.ao(H.ah(T,R.L))+H.ao(H.ah(T,R.G))-H.ao(R)<1e-7)&&((H.ao(H.ah(T,l.L))+H.ao(H.ah(T,l.G))-H.ao(l)<1e-7)||(H.ao(H.ah(T,l.L))>H.ao(H.ah(T,l.G))))){return T;}},aS:function(R,l){var rp=H.bG(H.line(l.L,l.G),H.line(R.L,R.G));var aO=Math.atan2(R.L.y-R.G.y,R.L.x-R.G.x);var ad=Math.atan2(l.L.y-rp.y,l.L.x-rp.x);if((aO>=0&&aO>ad&&ad>(aO-Math.PI))||(aO<0&&(ad<aO||ad>(aO+Math.PI)))){var bw=aO-Math.PI/2;var p=R.p;}else{var bw=aO+Math.PI/2;var p=1/R.p;}if(Math.abs(Math.sin(bw-ad)*p)>1){var bd=bw*2-ad}else{var bd=bw+Math.PI-Math.asin(Math.sin(bw-ad)*p);}return H.l(rp,H.aH(rp.x+Math.cos(bd),rp.y+Math.sin(bd)));}};bV["arcinterface"]={bx:"折射率",create:function(K){return{R:{type:"arcinterface",L:K,G:H.aH(K.x+al,K.y),p:1.2},O:{J:2}};},aY:function(R,canvas){var h=canvas.getContext('2d');h.fillStyle="rgb(255,0,255)";if(R.F){var center=H.aZ(H.aq(H.line(R.L,R.F)),H.aq(H.line(R.G,R.F)));var r=H.length(center,R.F);var V=Math.atan2(R.L.y-center.y,R.L.x-center.x);var v=Math.atan2(R.G.y-center.y,R.G.x-center.x);var t=Math.atan2(R.F.y-center.y,R.F.x-center.x);var bf=(v<t&&t<V)||(V<v&&v<t)||(t<V&&V<v);h.strokeStyle="rgba(192,192,192,0.5)";h.lineWidth=4;h.beginPath();h.arc(center.x,center.y,bf?r-2:r+2,V,v,bf);h.stroke();h.strokeStyle="rgba(128,128,255,0.5)";h.lineWidth=4;h.beginPath();h.arc(center.x,center.y,bf?r+2:r-2,V,v,bf);h.stroke();h.strokeStyle="rgba(0,0,0,255)";h.lineWidth=0.5;h.beginPath();h.arc(center.x,center.y,r,V,v,bf);h.stroke();h.fillRect(R.F.x-2,R.F.y-2,3,3);h.lineWidth=1}h.fillStyle="rgb(255,0,0)";h.fillRect(R.L.x-2,R.L.y-2,3,3);h.fillRect(R.G.x-2,R.G.y-2,3,3);},move:function(R,aL,bk){R.L.x=R.L.x+aL;R.L.y=R.L.y+bk;R.G.x=R.G.x+aL;R.G.y=R.G.y+bk;R.F.x=R.F.x+aL;R.F.y=R.F.y+bk;return R;},ae:function(R,K){if(!R.F){R.F=K;return{R:R,O:{J:3}};}if(bQ(K,R.L)){return{O:{J:1}};}if(bQ(K,R.G)){return{O:{J:2}};}if(bQ(K,R.F)){return{O:{J:3}};}var center=H.aZ(H.aq(H.line(R.L,R.F)),H.aq(H.line(R.G,R.F)));var r=H.length(center,R.F);var V=Math.atan2(R.L.y-center.y,R.L.x-center.x);var v=Math.atan2(R.G.y-center.y,R.G.x-center.x);var t=Math.atan2(R.F.y-center.y,R.F.x-center.x);var an=Math.atan2(K.y-center.y,K.x-center.x);if(Math.abs(H.length(center,K)-r)<8&&(((v<t&&t<V)||(V<v&&v<t)||(t<V&&V<v))==((v<an&&an<V)||(V<v&&v<an)||(an<V&&V<v)))){return{O:{J:0,bz:K}};}return false;},dragging:function(R,K,O){if(O.J==1){R.L=K;return{R:R}}if(O.J==2){R.G=K;return{R:R}}if(O.J==3){R.F=K;return{R:R}}if(O.J==0){var by=O.bz.x-K.x;var aC=O.bz.y-K.y;R.L.x=R.L.x-by;R.L.y=R.L.y-aC;R.G.x=R.G.x-by;R.G.y=R.G.y-aC;R.F.x=R.F.x-by;R.F.y=R.F.y-aC;return{R:R,O:{J:0,bz:K}}}},be:function(R,l){if(!R.F){return;}var center=H.aZ(H.aq(H.line(R.L,R.F)),H.aq(H.line(R.G,R.F)));var r=H.length(center,R.F);var V=Math.atan2(R.L.y-center.y,R.L.x-center.x);var v=Math.atan2(R.G.y-center.y,R.G.x-center.x);var t=Math.atan2(R.F.y-center.y,R.F.x-center.x);var T=H.aK(H.line(l.L,l.G),H.circle(center,R.G));var bp;var aF=[];var ag=[];for(var i=1;i<=2;i++){bp=Math.atan2(T[i].y-center.y,T[i].x-center.x);aF[i]=(((v<t&&t<V)||(V<v&&v<t)||(t<V&&V<v))==((v<bp&&bp<V)||(V<v&&v<bp)||(bp<V&&V<v)))&&((H.length(T[i],l.L)>H.length(T[i],l.G)));ag[i]=H.length(l.L,T[i])}if(aF[1]&&((!aF[2])||ag[1]<ag[2])){return T[1];}if(aF[2]&&((!aF[1])||ag[2]<ag[1])){return T[2];}},aS:function(R,l){var center=H.aZ(H.aq(H.line(R.L,R.F)),H.aq(H.line(R.G,R.F)));var rp=this.be(R,l);var V=Math.atan2(R.L.y-center.y,R.L.x-center.x);var v=Math.atan2(R.G.y-center.y,R.G.x-center.x);var t=Math.atan2(R.F.y-center.y,R.F.x-center.x);var bf=(v<t&&t<V)||(V<v&&v<t)||(t<V&&V<v);var aO=Math.atan2(rp.y-center.y,rp.x-center.x)-Math.PI/2;if(aO<= -Math.PI){aO=aO+Math.PI*2}var ad=Math.atan2(l.L.y-rp.y,l.L.x-rp.x);var ai=(aO>=0&&aO>ad&&ad>(aO-Math.PI))||(aO<0&&(ad<aO||ad>(aO+Math.PI)));if(ai){var bw=aO-Math.PI/2}else{var bw=aO+Math.PI/2}if(ai!=bf){var p=R.p;}else{var p=1/R.p;}if(Math.abs(Math.sin(bw-ad)*p)>1){var bd=bw*2-ad}else{var bd=bw+Math.PI-Math.asin(Math.sin(bw-ad)*p);}return H.l(rp,H.aH(rp.x+Math.cos(bd),rp.y+Math.sin(bd)));}};var canvas;var k=[];var ds=0;var am= -1;var O={};var az= -1;var aB="";var bE=[];var cq=0;var bP=1.0;var cI=false;var dF=true;var al=20;var aT=[];var bi=0;var as=20;var ab;var mode;var bC= -1;function load(){canvas=document.getElementById('bZ');mode=document.getElementById("mode").value;ab=H.circle(H.aH(0,0),20);document.getElementById('aP').value="";ap();bg();};function aY(){if(bC!= -1){clearTimeout(bC);bC= -1;}cK();bO.cU(canvas);bE=[];aV=0;for(var i=0;i<k.length;i++){bV[k[i].type].aY(k[i],canvas);if(bV[k[i].type].bD){bV[k[i].type].bD(k[i])}}dC();var bU=mode=="observed_light"||mode=="observed_imagess";if(bU){var h=canvas.getContext('2d');h.globalAlpha=1;h.beginPath();h.fillStyle="black";h.arc(ab.c.x,ab.c.y,ab.r,0,Math.PI*2,false);h.fill();}};function bK(l){bE[bE.length]=l;};function dC(){bC= -1;var dO=new Date();var bU=mode=="observed_light"||mode=="observed_images";canvas.getContext('2d').globalAlpha=document.getElementById("bP").value;var aR;var bS;var aI;var bB;var aj;var aJ;var bb;var bh=bE.length;while(bh!=0){if(new Date()-dO>(bU?500:100)){document.getElementById('status').innerHTML="處理中... (已處理"+aV+"段光線,剩下"+bh+"條光線)";bC=setTimeout("dC()",10);return;}bh=0;aj=null;aI=null;for(var j=0;j<bE.length;j++){aR=bE[j];if(aR){bB=null;aJ=null;bb=Infinity;bS= !bU;for(var i=0;i<k.length;i++){if(bV[k[i].type].be){var bs=bV[k[i].type].be(k[i],aR);if(typeof bs!="undefined"){var au=H.length(aR.L,bs);if(au<bb&&au>1e-5){bB=k[i];aJ=bs;bb=au}}}}if(bb==Infinity){if(mode=="light"){bO.aY(aR,canvas,"rgb(0,0,255)");}if(mode=="extended_light"){bO.aY(H.line(aR.L,aR.G),canvas,"rgb(255,128,0)");}if(bU){var rp=H.aK(aR,ab);if(rp[1]){if(H.length(rp[1],aR.L)>H.length(rp[1],aR.G)){bS=true;if(mode=="observed_light"){bO.aY(H.l(rp[1],aR.L),canvas,"rgb(255,128,0)");}}}}bE[j]=null}else{if(mode=="light"){bO.aY(H.ah(aR.L,aJ),canvas,"rgb(0,0,255)")}if(bU){var rp=H.aK(aR,ab);if(rp[1]){if(H.length(aR.L,rp[1])+H.length(rp[1],aJ)-H.length(aR.L,aJ)<1e-7){bS=true;if(mode=="observed_light"){bO.aY(H.l(rp[1],aR.L),canvas,"rgb(255,128,0)");}}}}bE[j]=bV[bB.type].aS(bB,aR)}if(aI&&mode=="observed_images"&&bS){var ay=H.aZ(aR,aI);if(H.length(ay,aR.L)+H.length(ay,rp[1])-H.length(aR.L,rp[1])<1e-7||H.length(ay,aR.L)<H.length(ay,rp[1])){bO.aY(H.aZ(aR,aI),canvas,"rgb(255,128,0)");}}if(aI&&mode=="images"&&bS){bO.aY(H.aZ(aR,aI),canvas,"rgb(255,128,0)");}aI=aR;aj=bB;aV=aV+1;if(bE[j]){bh=bh+1;}}}}canvas.getContext('2d').globalAlpha=1.0;for(var i=0;i<k.length;i++){bV[k[i].type].aY(k[i],canvas)}if(bU){var h=canvas.getContext('2d');h.globalAlpha=1;h.beginPath();h.fillStyle="black";h.arc(ab.c.x,ab.c.y,ab.r,0,Math.PI*2,false);h.fill();}document.getElementById('status').innerHTML="完成,共處理"+aV+"段光線"};function bQ(K,aH){return Math.sqrt(Math.pow(aH.x-K.x,2)+Math.pow(aH.y-K.y,2))<9;};function bj(K,ah){return H.length(K,ah.L)+H.length(K,ah.G)-H.ao(ah)<2;};function cV(e){if(document.getElementById("grid").checked!=e.ctrlKey){var K=H.aH(Math.round((e.pageX-e.target.offsetLeft)/al)*al,Math.round((e.pageY-e.target.offsetTop)/al)*al)}else{var K=H.aH(e.pageX-e.target.offsetLeft,e.pageY-e.target.offsetTop)}var bU=mode=="observed_light"||mode=="observed_images";if(bU){if(H.length(K,ab.c)<ab.r){am= -4;return;}}var aN;if(document.getElementById("ce").checked!=e.altKey){for(var i=0;i<k.length;i++){if(typeof k[i]!="undefined"){aN=bV[k[i].type].ae(k[i],K);if(aN){bL(i);if(aN.R){k[i]=aN.R;aY()}if(aN.O){am=i;O=aN.O;}return;}}}}if(am== -1){if((aB=="")||e.shiftKey){am= -3;O={bz:K}}else{aN=bV[aB].create(K);if(aN.R){k[k.length]=aN.R;}if(aN.O){am=k.length-1;O=aN.O;}if(k[az]){if(k[az].type==k[k.length-1].type){k[k.length-1].p=k[az].p;}}bL(k.length-1);aY()}}};function bY(e){if(document.getElementById("grid").checked!=e.ctrlKey){var K=H.aH(Math.round((e.pageX-e.target.offsetLeft)/al)*al,Math.round((e.pageY-e.target.offsetTop)/al)*al)}else{var K=H.aH(e.pageX-e.target.offsetLeft,e.pageY-e.target.offsetTop)}var bU=mode=="observed_light"||mode=="observed_images";if(am== -4){ab.c=K;aY();}var aN;if(am>=0){aN=bV[k[am].type].dragging(k[am],K,O);if(aN.R){k[am]=aN.R;}if(aN.O){O=aN.O;}aY();}if(am== -2){k[k.length]=bV[aB].create();if(k[az]){if(k[az].type==k[k.length-1].type){k[k.length-1].p=k[az].p;}}switch(bV[aB].cA){case "aH":break;case "aX":k[k.length-1].L.x=K.x;k[k.length-1].L.y=K.y;k[k.length-1].G.x=K.x;k[k.length-1].G.y=K.y;am=k.length-1;O={J:2,bz:K};bL(k.length-1)}aY();}if(am== -3){var by=K.x-O.bz.x;var aC=K.y-O.bz.y;for(var i=0;i<k.length;i++){k[i]=bV[k[i].type].move(k[i],by,aC)}O.bz=K;ab.c.x+=by;ab.c.y+=aC;aY();}};function dR(e){am= -1;O={};bg()};function bL(index){az=index;document.getElementById('aP').value=k[index].p;document.getElementById('bx').innerHTML=bV[k[index].type].bx?bV[k[index].type].bx:"物件參數"};function cb(){for(var i=0;i<k.length;i++){if(bV[k[i].type].bx==bV[k[az].type].bx){k[i].p=document.getElementById('aP').value;}}};function cs(index){for(var i=index;i<k.length-1;i++){k[i]=k[i+1];}k.length=k.length-1;};function bg(){bi=(bi+1)%as;aT[bi]=document.getElementById("aE").value;};function cJ(e){if(e.ctrlKey&&e.keyCode==90){bi=(bi+(as-1))%as;document.getElementById('aE').value=aT[bi];ap();return false;}if(e.altKey&&e.keyCode==78){k.length=0;aY();bg();return false;}if(e.keyCode==46){cs(az);aY();bg();return false;}};function cK(){document.getElementById("aE").value=JSON.stringify({k:k,mode:mode,bP:document.getElementById("bP").value,ab:ab});};function ap(){bM=JSON.parse(document.getElementById("aE").value);k=bM.k;document.getElementById("mode").value=mode=bM.mode;document.getElementById("bP").value=bM.bP;ab=bM.ab;aY();}//-->
 </script> </head> <body onload="load()" onkeydown="return cJ(event)"> <br> <br> <br> <canvas id="bZ" width="2000" height="1000" onmousedown="document.body.focus();cV(event);return false;" onmousemove="bY(event)" onmouseup="dR(event)"></canvas> <textarea id="aE" style="width:100%;height:250px;" onchange="ap()"></textarea> <br> <div style="position:fixed;top:0px;left:0px"> 新增: <input type="button" value="光線" onclick="aB='laser';"> <input type="button" value="發光點" onclick="aB='radiant';"> <input type="button" value="平行光" onclick="aB='aa';"> <input type="button" value="鏡子" onclick="aB='ba';"> <input type="button" value="弧形鏡" onclick="aB='arcmirror';"> <input type="button" value="理想透鏡" onclick="aB='bv';"> <input type="button" value="介面" onclick="aB='interface';"> <input type="button" value="弧形介面" onclick="aB='arcinterface';"> <input type="button" value="折射鏡" onclick="aB='refractor';"> <input type="button" value="黑線" onclick="aB='blackline';"> <span id="bx">物件參數</span>: <input type="text" id="aP" onchange="k[az].p=this.value;aY();bg();"> <input type="button" value="套用全部" onclick="cb();aY();bg();"> <input type="button" value="刪除物件" onclick="cs(az);aY();bg();"> <br> <input type="checkbox" id="ce" checked>拖曳物件 <input type="checkbox" id="grid">對齊格線 <input type="button" value="平移畫面" onclick="aB='';"> <input type="button" value="復原" onclick="bi=(bi+(as-1))%as;document.getElementById('aE').value=aT[bi];ap();"> <input type="button" value="重作" onclick="bi=(bi+1)%as;document.getElementById('aE').value=aT[bi];ap();"> <input type="button" value="清除全部" onclick="k.length=0;aY();bg();"> <input type="button" value="更新畫面" onclick="aY();"> <span id="status"></span> <br> 光線透明度: <input type="text" id="bP" value="1.0" onchange="aY();"> 顯示: <select id="mode" onchange="mode=this.value;aY();"> <option value="light">光線</option> <option value="extended_light">延長光線</option> <option value="images">像</option> <option value="observed_light">觀察者所見的光線</option> <option value="observed_images">觀察者所見的像</option> </select> <input type="button" value="重設觀察者" onclick="ab=H.circle(H.aH(0,0),20);aY();"> </div> </body> </html>

