(function(){var O={xxa:function(ag,ah){return{type:"xxa",x:ag,y:ah,exist:true}},xxb:function(ah,ag){return{type:"xxb",p1:ah,p2:ag,exist:true}},xxc:function(ah,ag){return{type:"xxc",p1:ah,p2:ag,exist:true}},xxd:function(ah,ag){return{type:"xxd",p1:ah,p2:ag,exist:true}},xxe:function(ah,ag){return{type:"xxd",p1:ah,p2:ag,exist:true}},xxf:function(ah,ag){if(typeof ag=="object"&&ag.type=="xxa"){return{type:"xxf",c:ah,r:this.xxd(ah,ag),exist:true}}else{return{type:"xxf",c:ah,r:ag,exist:true}}},xxg:function(ah,ag){if(ah.type=="xxb"&&ag.type=="xxb"){return this.xxh(ah,ag)}if(ah.type=="xxb"&&ag.type=="xxf"){return this.xxi(ah,ag)}if(ah.type=="xxf"&&ag.type=="xxb"){return this.xxi(ag,ah)}if(ah.type=="xxf"&&ag.type=="xxf"){return this.xxj(ah,ag)}},xxh:function(ak,ai){var aj,ah,an,al,ag,am;if(Math.abs(ak.p2.x-ak.p1.x)<1e-8){ah=ak.p1.x;an=(ai.p2.y-ai.p1.y)/(ai.p2.x-ai.p1.x);al=ai.p1.y-an*(ai.p1.x);ag=ah;am=an*ah+al}if(Math.abs(ai.p2.x-ai.p1.x)<1e-8){aj=(ak.p2.y-ak.p1.y)/(ak.p2.x-ak.p1.x);ah=ak.p1.y-aj*(ak.p1.x);al=ai.p1.x;ag=al;am=aj*al+ah}if(!(Math.abs(ak.p2.x-ak.p1.x)<1e-8)&&!(Math.abs(ai.p2.x-ai.p1.x)<1e-8)){aj=(ak.p2.y-ak.p1.y)/(ak.p2.x-ak.p1.x);ah=ak.p1.y-aj*(ak.p1.x);an=(ai.p2.y-ai.p1.y)/(ai.p2.x-ai.p1.x);al=ai.p1.y-an*(ai.p1.x);ag=(al-ah)/(aj-an);am=aj*ag+ah}return O.xxa(ag,am)},xxi:function(ak,al){var at,aq,ao,an,am,aj,ai,ag;var ar=new Array();var ap=new Array();var ah=new Array();if(Math.abs(ak.p2.x-ak.p1.x)<1e-8){aq=ak.p1.x;ao=al.c.x;an=al.c.y;am=(typeof al.r=="object")?(Math.sqrt(Math.pow(al.r.p1.x-al.r.p2.x,2)+Math.pow(al.r.p1.y-al.r.p2.y,2))):(al.r);ar[1]=aq;ar[2]=aq;ap[1]=(2*an+Math.sqrt(Math.pow(2*an,2)-4*(Math.pow(ar[1]-ao,2)+Math.pow(an,2)-Math.pow(am,2))))/2;ap[2]=(2*an-Math.sqrt(Math.pow(2*an,2)-4*(Math.pow(ar[2]-ao,2)+Math.pow(an,2)-Math.pow(am,2))))/2}else{at=(ak.p2.y-ak.p1.y)/(ak.p2.x-ak.p1.x);aq=ak.p1.y-at*(ak.p1.x);ao=al.c.x;an=al.c.y;am=(typeof al.r=="object")?(Math.sqrt(Math.pow(al.r.p1.x-al.r.p2.x,2)+Math.pow(al.r.p1.y-al.r.p2.y,2))):(al.r);aj=1+Math.pow(at,2);ai=-2*ao+2*at*aq-2*an*at;ag=Math.pow(ao,2)+Math.pow(aq,2)-2*an*aq+Math.pow(an,2)-Math.pow(am,2);ar[1]=(-ai+Math.sqrt(Math.pow(ai,2)-4*aj*ag))/(2*aj);ar[2]=(-ai-Math.sqrt(Math.pow(ai,2)-4*aj*ag))/(2*aj);ap[1]=at*ar[1]+aq;ap[2]=at*ar[2]+aq}ah[1]=O.xxa(ar[1],ap[1]);ah[2]=O.xxa(ar[2],ap[2]);return ah},xxj:function(am,al){var av,at,aq,ap,ao,an,ak,aj,ah,ag,aw;var au=new Array();var ar=new Array();var ai=new Array();av=am.c.x;at=am.c.y;aq=(typeof am.r=="object")?(Math.sqrt(Math.pow(am.r.p1.x-am.r.p2.x,2)+Math.pow(am.r.p1.y-am.r.p2.y,2))):(am.r);ap=al.c.x;ao=al.c.y;an=(typeof al.r=="object")?(Math.sqrt(Math.pow(al.r.p1.x-al.r.p2.x,2)+Math.pow(al.r.p1.y-al.r.p2.y,2))):(al.r);ak=(2*ao-2*at)/(2*ap-2*av);aj=(-Math.pow(av,2)-Math.pow(at,2)+Math.pow(aq,2)+Math.pow(ap,2)+Math.pow(ao,2)-Math.pow(an,2))/(2*ap-2*av);if(Math.abs(ap-av)<1e-8){ak=(Math.pow(av,2)+Math.pow(at,2)-Math.pow(aq,2)-Math.pow(ap,2)-Math.pow(ao,2)+Math.pow(an,2))/(2*ao-2*at);ah=1;ag=-2*av;aw=Math.pow(ak,2)+2*at*ak+Math.pow(av,2)+Math.pow(at,2)-Math.pow(aq,2);ar[1]=-ak;ar[2]=-ak;au[1]=(-ag+Math.sqrt(Math.pow(ag,2)-4*ah*aw))/(2*ah);au[2]=(-ag-Math.sqrt(Math.pow(ag,2)-4*ah*aw))/(2*ah)}else{ak=(2*ao-2*at)/(2*ap-2*av);aj=(-Math.pow(av,2)-Math.pow(at,2)+Math.pow(aq,2)+Math.pow(ap,2)+Math.pow(ao,2)-Math.pow(an,2))/(2*ap-2*av);ah=Math.pow(ak,2)+1;ag=2*(-ak)*aj-2*av*(-ak)-2*at;aw=Math.pow(aj,2)-2*av*aj+Math.pow(av,2)+Math.pow(at,2)-Math.pow(aq,2);ar[1]=(-ag+Math.sqrt(Math.pow(ag,2)-4*ah*aw))/(2*ah);ar[2]=(-ag-Math.sqrt(Math.pow(ag,2)-4*ah*aw))/(2*ah);au[1]=(-ak)*ar[1]+aj;au[2]=(-ak)*ar[2]+aj}ai[1]=O.xxa(au[1],ar[1]);ai[2]=O.xxa(au[2],ar[2]);return ai},xxk:function(ag){return Math.sqrt(Math.pow(ag.p1.x-ag.p2.x,2)+Math.pow(ag.p1.y-ag.p2.y,2))},length:function(ah,ag){return Math.sqrt(Math.pow(ah.x-ag.x,2)+Math.pow(ah.y-ag.y,2))},xxl:function(ah){var ag=O.xxj(O.xxf(ah.p1,ah.p2),O.xxf(ah.p2,ah.p1));return O.xxh(ah,O.xxb(ag[1],ag[2]))},xxm:function(ah){var ag=O.xxj(O.xxf(ah.p1,ah.p2),O.xxf(ah.p2,ah.p1));return O.xxb(ag[1],ag[2])},parallel:function(ag,al){var ak=O.xxf(ag.p1,al);var am=O.xxg(ag,ak)[1];var aj=O.xxf(am,ag.p1);var ai=O.xxf(al,ag.p1);var ah=O.xxg(aj,ai);if(Math.abs(ah[2].x-ag.p1.x)<0.00001&&Math.abs(ah[2].y-ag.p1.y)<0.00001){return O.xxb(ah[1],al)}else{return O.xxb(ah[2],al)}}};var L={xxn:function(ak,aj,ah){var ag=aj.getContext("2d");if(ak.type=="xxa"){if(typeof ah=="undefined"){ag.fillStyle="red"}else{ag.fillStyle=ah}ag.fillRect(ak.x-2,ak.y-2,5,5)}if(ak.type=="xxb"){if(typeof ah=="undefined"){ag.strokeStyle="black"}else{ag.strokeStyle=ah}ag.beginPath();al=Math.atan2((ak.p2.x-ak.p1.x),(ak.p2.y-ak.p1.y));ai=Math.abs(ak.p1.x)+Math.abs(ak.p1.y)+aj.height+aj.width;ag.moveTo(ak.p1.x-Math.sin(al)*ai,ak.p1.y-Math.cos(al)*ai);ag.lineTo(ak.p1.x+Math.sin(al)*ai,ak.p1.y+Math.cos(al)*ai);ag.stroke()}if(ak.type=="xxc"){if(typeof ah=="undefined"){ag.strokeStyle="black"}else{ag.strokeStyle=ah}var al,ai;ag.beginPath();al=Math.atan2((ak.p2.x-ak.p1.x),(ak.p2.y-ak.p1.y));ai=Math.abs(ak.p1.x)+Math.abs(ak.p1.y)+aj.height+aj.width;ag.moveTo(ak.p1.x,ak.p1.y);ag.lineTo(ak.p1.x+Math.sin(al)*ai,ak.p1.y+Math.cos(al)*ai);ag.stroke()}if(ak.type=="xxd"){if(typeof ah=="undefined"){ag.strokeStyle="black"}else{ag.strokeStyle=ah}ag.beginPath();ag.moveTo(ak.p1.x,ak.p1.y);ag.lineTo(ak.p2.x,ak.p2.y);ag.stroke()}if(ak.type=="xxf"){if(typeof ah=="undefined"){ag.strokeStyle="black"}else{ag.strokeStyle=ah}ag.beginPath();if(typeof ak.r=="object"){ag.arc(ak.c.x,ak.c.y,Math.sqrt(Math.pow(ak.r.p1.x-ak.r.p2.x,2)+Math.pow(ak.r.p1.y-ak.r.p2.y,2)),0,Math.PI*2,false)}else{ag.arc(ak.c.x,ak.c.y,ak.r,0,Math.PI*2,false)}ag.stroke()}},cls:function(ah){var ag=ah.getContext("2d");ag.clearRect(0,0,ah.width,ah.height)}};var l={};l.lineobj={xxs:function(ah,ag){ah.p2=ag;if(Math.sqrt(Math.pow(ah.p1.x-ag.x,2)+Math.pow(ah.p1.y-ag.y,2))>=5){ad()}},xxt:function(ah,ag){ah.p2=ag;if(Math.sqrt(Math.pow(ah.p1.x-ag.x,2)+Math.pow(ah.p1.y-ag.y,2))>=5){ad()}},xxu:function(ah,ag){if(Math.sqrt(Math.pow(ah.p1.x-ag.x,2)+Math.pow(ah.p1.y-ag.y,2))>=5){R=false}},xxv:function(ai,ah,ag){ai.p1.x=ai.p1.x+ah;ai.p1.y=ai.p1.y+ag;ai.p2.x=ai.p2.x+ah;ai.p2.y=ai.p2.y+ag},xxw:function(ai,ag,ah){if(S(ag,ai.p1)){ah.part=1;return true}if(S(ag,ai.p2)){ah.part=2;return true}if(Y(ag,ai)){ah.part=0;ah.mouse1=ag;return true}return false},xxx:function(ak,ag,aj){if(aj.part==1){ak.p1=ag}if(aj.part==2){ak.p2=ag}if(aj.part==0){var ai=aj.mouse1.x-ag.x;var ah=aj.mouse1.y-ag.y;ak.p1.x=ak.p1.x-ai;ak.p1.y=ak.p1.y-ah;ak.p2.x=ak.p2.x-ai;ak.p2.y=ak.p2.y-ah;aj.mouse1=ag}},xxy:function(ai,ag){var ah=O.xxg(O.xxb(ag.p1,ag.p2),O.xxb(ai.p1,ai.p2));if((O.xxk(O.xxe(ah,ai.p1))+O.xxk(O.xxe(ah,ai.p2))-O.xxk(ai)<1e-7)&&((O.xxk(O.xxe(ah,ag.p1))+O.xxk(O.xxe(ah,ag.p2))-O.xxk(ag)<1e-7)||(O.xxk(O.xxe(ah,ag.p1))>O.xxk(O.xxe(ah,ag.p2))))){return ah}}};l.refractor={p_name:"折射率",xxo:1,xxp:3,xxq:0.01,xxr:function(ag){return{type:"refractor",path:[{x:ag.x,y:ag.y,arc:false}],notDone:true,p:1.5}},xxs:function(ah,ag){if(ah.path.length>1){if(ah.path.length>3&&S(ag,ah.path[0])){ah.path.length--;ah.notDone=false;ad();return}ah.path[ah.path.length-1]={x:ag.x,y:ag.y};ah.path[ah.path.length-1].arc=true}},xxt:function(ah,ag){if(!ah.notDone){return}if(typeof ah.path[ah.path.length-1].arc!="undefined"){if(ah.path[ah.path.length-1].arc&&Math.sqrt(Math.pow(ah.path[ah.path.length-1].x-ag.x,2)+Math.pow(ah.path[ah.path.length-1].y-ag.y,2))>=5){ah.path[ah.path.length]=ag;ad()}}else{ah.path[ah.path.length-1]={x:ag.x,y:ag.y};ad()}},xxu:function(ah,ag){if(!ah.notDone){R=false;ad();return}if(ah.path.length>3&&S(ag,ah.path[0])){ah.path.length--;ah.notDone=false;R=false;ad();return}ah.path[ah.path.length-1]={x:ag.x,y:ag.y};ah.path[ah.path.length-1].arc=false;ah.path[ah.path.length]={x:ag.x,y:ag.y};ad()},xxn:function(am,al){var at=al.getContext("2d");if(am.notDone){at.beginPath();at.moveTo(am.path[0].x,am.path[0].y);for(var an=0;an<am.path.length-1;an++){if(am.path[(an+1)].arc&&!am.path[an].arc&&an<am.path.length-2){var ar=O.xxa(am.path[an].x,am.path[an].y);var aq=O.xxa(am.path[(an+2)].x,am.path[(an+2)].y);var ap=O.xxa(am.path[(an+1)].x,am.path[(an+1)].y);var ai=O.xxh(O.xxm(O.xxb(ar,ap)),O.xxm(O.xxb(aq,ap)));var ah=O.length(ai,ap);var ak=Math.atan2(ar.y-ai.y,ar.x-ai.x);var aj=Math.atan2(aq.y-ai.y,aq.x-ai.x);var ag=Math.atan2(ap.y-ai.y,ap.x-ai.x);var ao=(aj<ag&&ag<ak)||(ak<aj&&aj<ag)||(ag<ak&&ak<aj);at.arc(ai.x,ai.y,ah,ak,aj,ao)}else{if(!am.path[(an+1)].arc&&!am.path[an].arc){at.lineTo(am.path[(an+1)].x,am.path[(an+1)].y)}}}at.globalAlpha=1;at.strokeStyle="rgb(128,128,128)";at.lineWidth=1;at.stroke()}else{at.beginPath();at.moveTo(am.path[0].x,am.path[0].y);for(var an=0;an<am.path.length;an++){if(am.path[(an+1)%am.path.length].arc&&!am.path[an%am.path.length].arc){var ar=O.xxa(am.path[an%am.path.length].x,am.path[an%am.path.length].y);var aq=O.xxa(am.path[(an+2)%am.path.length].x,am.path[(an+2)%am.path.length].y);var ap=O.xxa(am.path[(an+1)%am.path.length].x,am.path[(an+1)%am.path.length].y);var ai=O.xxh(O.xxm(O.xxb(ar,ap)),O.xxm(O.xxb(aq,ap)));var ah=O.length(ai,ap);var ak=Math.atan2(ar.y-ai.y,ar.x-ai.x);var aj=Math.atan2(aq.y-ai.y,aq.x-ai.x);var ag=Math.atan2(ap.y-ai.y,ap.x-ai.x);var ao=(aj<ag&&ag<ak)||(ak<aj&&aj<ag)||(ag<ak&&ak<aj);at.arc(ai.x,ai.y,ah,ak,aj,ao)}else{if(!am.path[(an+1)%am.path.length].arc&&!am.path[an%am.path.length].arc){at.lineTo(am.path[(an+1)%am.path.length].x,am.path[(an+1)%am.path.length].y)}}}at.fillStyle="rgb(80,80,80)";at.globalAlpha=1-(1/am.p);at.fill();at.globalAlpha=1}at.lineWidth=1;for(var an=0;an<am.path.length;an++){if(typeof am.path[an].arc!="undefined"){if(am.path[an].arc){at.fillStyle="rgb(255,0,255)";at.fillRect(am.path[an].x-2,am.path[an].y-2,3,3)}else{at.fillStyle="rgb(255,0,0)";at.fillRect(am.path[an].x-2,am.path[an].y-2,3,3)}}}},xxv:function(aj,ah,ag){for(var ai=0;ai<aj.path.length;ai++){aj.path[ai].x+=ah;aj.path[ai].y+=ag}},xxw:function(am,ao,ar){for(var an=0;an<am.path.length;an++){if(S(ao,am.path[an])){ar.part=1;ar.index=an;return true}}for(var an=0;an<am.path.length;an++){if(am.path[(an+1)%am.path.length].arc&&!am.path[an%am.path.length].arc){var at=O.xxa(am.path[an%am.path.length].x,am.path[an%am.path.length].y);var aq=O.xxa(am.path[(an+2)%am.path.length].x,am.path[(an+2)%am.path.length].y);var ap=O.xxa(am.path[(an+1)%am.path.length].x,am.path[(an+1)%am.path.length].y);var ai=O.xxh(O.xxm(O.xxb(at,ap)),O.xxm(O.xxb(aq,ap)));var ah=O.length(ai,ap);var ak=Math.atan2(at.y-ai.y,at.x-ai.x);var aj=Math.atan2(aq.y-ai.y,aq.x-ai.x);var ag=Math.atan2(ap.y-ai.y,ap.x-ai.x);var al=Math.atan2(ao.y-ai.y,ao.x-ai.x);if(Math.abs(O.length(ai,ao)-ah)<8&&(((aj<ag&&ag<ak)||(ak<aj&&aj<ag)||(ag<ak&&ak<aj))==((aj<al&&al<ak)||(ak<aj&&aj<al)||(al<ak&&ak<aj)))){ar.part=0;ar.mouse1=ao;return true}}else{if(!am.path[(an+1)%am.path.length].arc&&!am.path[an%am.path.length].arc){if(Y(ao,O.xxe(am.path[(an)%am.path.length],am.path[(an+1)%am.path.length]))){ar.part=0;ar.mouse1=ao;return true}}}}},xxx:function(ai,ag,ah){if(ah.part==1){ai.path[ah.index].x=ag.x;ai.path[ah.index].y=ag.y}if(ah.part==0){this.xxv(ai,ag.x-ah.mouse1.x,ag.y-ah.mouse1.y);ah.mouse1=ag}},xxy:function(aq,ap){if(aq.notDone){return}var aw=Infinity;var ak;var am=null;var av=null;for(var au=0;au<aq.path.length;au++){av=null;if(aq.path[(au+1)%aq.path.length].arc&&!aq.path[au%aq.path.length].arc){var aj=O.xxa(aq.path[au%aq.path.length].x,aq.path[au%aq.path.length].y);var ai=O.xxa(aq.path[(au+2)%aq.path.length].x,aq.path[(au+2)%aq.path.length].y);var ah=O.xxa(aq.path[(au+1)%aq.path.length].x,aq.path[(au+1)%aq.path.length].y);var ax=O.xxh(O.xxm(O.xxb(aj,ah)),O.xxm(O.xxb(ai,ah)));var ar=O.length(ax,ah);var aA=Math.atan2(aj.y-ax.y,aj.x-ax.x);var az=Math.atan2(ai.y-ax.y,ai.x-ax.x);var ay=Math.atan2(ah.y-ax.y,ah.x-ax.x);var al=O.xxi(O.xxb(ap.p1,ap.p2),O.xxf(ax,ai));var an;var at=[];var ag=[];for(var ao=1;ao<=2;ao++){an=Math.atan2(al[ao].y-ax.y,al[ao].x-ax.x);at[ao]=(((az<ay&&ay<aA)||(aA<az&&az<ay)||(ay<aA&&aA<az))==((az<an&&an<aA)||(aA<az&&az<an)||(an<aA&&aA<az)))&&((O.length(al[ao],ap.p1)>O.length(al[ao],ap.p2)));ag[ao]=O.length(ap.p1,al[ao])}if(at[1]&&((!at[2])||ag[1]<ag[2])){av=al[1];ak=ag[1]}if(at[2]&&((!at[1])||ag[2]<ag[1])){av=al[2];ak=ag[2]}}else{if(!aq.path[(au+1)%aq.path.length].arc&&!aq.path[au%aq.path.length].arc){var al=O.xxg(O.xxb(ap.p1,ap.p2),O.xxb(aq.path[au%aq.path.length],aq.path[(au+1)%aq.path.length]));if((O.length(al,aq.path[au%aq.path.length])+O.length(al,aq.path[(au+1)%aq.path.length])-O.length(aq.path[au%aq.path.length],aq.path[(au+1)%aq.path.length])<1e-7)&&((O.length(al,ap.p1)+O.length(al,ap.p2)-O.xxk(ap)<1e-7)||(O.length(al,ap.p1)>O.length(al,ap.p2)))){ak=O.length(ap.p1,al);av=al}}}if(av){if(ak<aw&&ak>0.00001){aw=ak;am=av}}}if(am){return am}},shot:function(av,au){if(av.notDone){return}var aC=h.getContext("2d");aC.beginPath();aC.moveTo(av.path[0].x,av.path[0].y);var aJ=Infinity;var al;var aq=null;var aI=null;var aO;for(var aG=0;aG<av.path.length;aG++){aI=null;if(av.path[(aG+1)%av.path.length].arc&&!av.path[aG%av.path.length].arc){var ak=O.xxa(av.path[aG%av.path.length].x,av.path[aG%av.path.length].y);var ai=O.xxa(av.path[(aG+2)%av.path.length].x,av.path[(aG+2)%av.path.length].y);var ah=O.xxa(av.path[(aG+1)%av.path.length].x,av.path[(aG+1)%av.path.length].y);var aK=O.xxh(O.xxm(O.xxb(ak,ah)),O.xxm(O.xxb(ai,ah)));var ax=O.length(aK,ah);var aN=Math.atan2(ak.y-aK.y,ak.x-aK.x);var aM=Math.atan2(ai.y-aK.y,ai.x-aK.x);var aL=Math.atan2(ah.y-aK.y,ah.x-aK.x);var aH=(aM<aL&&aL<aN)||(aN<aM&&aM<aL)||(aL<aN&&aN<aM);var ap=O.xxi(O.xxb(au.p1,au.p2),O.xxf(aK,ai));var ar;var aD=[];var ag=[];for(var at=1;at<=2;at++){ar=Math.atan2(ap[at].y-aK.y,ap[at].x-aK.x);aD[at]=(((aM<aL&&aL<aN)||(aN<aM&&aM<aL)||(aL<aN&&aN<aM))==((aM<ar&&ar<aN)||(aN<aM&&aM<ar)||(ar<aN&&aN<aM)))&&((O.length(ap[at],au.p1)>O.length(ap[at],au.p2)));ag[at]=O.length(au.p1,ap[at])}if(aD[1]&&((!aD[2])||ag[1]<ag[2])){aI=ap[1];al=ag[1]}if(aD[2]&&((!aD[1])||ag[2]<ag[1])){aI=ap[2];al=ag[2]}aC.arc(aK.x,aK.y,ax,aN,aM,aH)}else{if(!av.path[(aG+1)%av.path.length].arc&&!av.path[aG%av.path.length].arc){var ap=O.xxg(O.xxb(au.p1,au.p2),O.xxb(av.path[aG%av.path.length],av.path[(aG+1)%av.path.length]));if((O.length(ap,av.path[aG%av.path.length])+O.length(ap,av.path[(aG+1)%av.path.length])-O.length(av.path[aG%av.path.length],av.path[(aG+1)%av.path.length])<1e-7)&&((O.length(ap,au.p1)+O.length(ap,au.p2)-O.xxk(au)<1e-7)||(O.length(ap,au.p1)>O.length(ap,au.p2)))){al=O.length(au.p1,ap);aI=ap}aC.lineTo(av.path[(aG+1)%av.path.length].x,av.path[(aG+1)%av.path.length].y)}}if(aI){if(al<aJ&&al>0.00001){aJ=al;aq=aI;aO=aG}}}if(aC.isPointInPath((au.p1.x+aq.x)*0.5,(au.p1.y+aq.y)*0.5)){var az=av.p}else{var az=1/av.p}if(av.path[(aO+1)%av.path.length].arc&&!av.path[aO%av.path.length].arc){var ak=O.xxa(av.path[aO%av.path.length].x,av.path[aO%av.path.length].y);var ai=O.xxa(av.path[(aO+2)%av.path.length].x,av.path[(aO+2)%av.path.length].y);var ah=O.xxa(av.path[(aO+1)%av.path.length].x,av.path[(aO+1)%av.path.length].y);var aK=O.xxh(O.xxm(O.xxb(ak,ah)),O.xxm(O.xxb(ai,ah)));var ax=O.length(aK,ah);var aN=Math.atan2(ak.y-aK.y,ak.x-aK.x);var aM=Math.atan2(ai.y-aK.y,ai.x-aK.x);var aL=Math.atan2(ah.y-aK.y,ah.x-aK.x);var aH=(aM<aL&&aL<aN)||(aN<aM&&aM<aL)||(aL<aN&&aN<aM);var aj=Math.atan2(aq.y-aK.y,aq.x-aK.x)-Math.PI/2;if(aj<=-Math.PI){aj=aj+Math.PI*2}var aw=Math.atan2(au.p1.y-aq.y,au.p1.x-aq.x);var am=(aj>=0&&aj>aw&&aw>(aj-Math.PI))||(aj<0&&(aw<aj||aw>(aj+Math.PI)));if(am){var aA=aj-Math.PI/2}else{var aA=aj+Math.PI/2}if(am!=aH){}else{}}else{if(!av.path[(aO+1)%av.path.length].arc&&!av.path[aO%av.path.length].arc){var aj=Math.atan2(av.path[aO%av.path.length].y-av.path[(aO+1)%av.path.length].y,av.path[aO%av.path.length].x-av.path[(aO+1)%av.path.length].x);var aw=Math.atan2(au.p1.y-aq.y,au.p1.x-aq.x);if((aj>=0&&aj>aw&&aw>(aj-Math.PI))||(aj<0&&(aw<aj||aw>(aj+Math.PI)))){var aA=aj-Math.PI/2}else{var aA=aj+Math.PI/2}}}if(Math.abs(Math.sin(aA-aw)*az)>1){var aF=aA*2-aw;au.p1=aq;au.p2=O.xxa(aq.x+Math.cos(aF),aq.y+Math.sin(aF))}else{var aF=aA+Math.PI-Math.asin(Math.sin(aA-aw)*az);var ao=(aA+Math.PI)-aF;var ay=aA-aw;var an=0.5*(Math.pow(Math.sin(ao-ay)/Math.sin(ao+ay),2)+Math.pow(Math.tan(ao-ay)/Math.tan(ao+ay),2));var aB=aA*2-aw;var aE=O.xxc(aq,O.xxa(aq.x+Math.cos(aB),aq.y+Math.sin(aB)));aE.brightness=au.brightness*an;aE.gap=au.gap;if(aE.brightness>0.01){t(aE)}au.p1=aq;au.p2=O.xxa(aq.x+Math.cos(aF),aq.y+Math.sin(aF));au.brightness=au.brightness*(1-an)}}};l.laser={xxr:function(ag){return{type:"laser",p1:ag,p2:O.xxa(ag.x+p,ag.y)}},xxs:l.lineobj.xxs,xxt:l.lineobj.xxt,xxu:l.lineobj.xxu,xxv:l.lineobj.xxv,xxw:l.lineobj.xxw,xxx:l.lineobj.xxx,xxn:function(ai,ah){var ag=ah.getContext("2d");ag.fillStyle="rgb(255,0,0)";ag.fillRect(ai.p1.x-2,ai.p1.y-2,5,5);ag.fillRect(ai.p2.x-2,ai.p2.y-2,3,3)},xxz:function(ah){var ag=O.xxc(ah.p1,ah.p2);ag.brightness=1;ag.gap=true;ag.isNew=true;t(ag)}};l.mirror={xxr:function(ag){return{type:"mirror",p1:ag,p2:O.xxa(ag.x+p,ag.y)}},xxs:l.lineobj.xxs,xxt:l.lineobj.xxt,xxu:l.lineobj.xxu,xxv:l.lineobj.xxv,xxw:l.lineobj.xxw,xxx:l.lineobj.xxx,xxy:l.lineobj.xxy,xxn:function(ai,ah){var ag=ah.getContext("2d");ag.strokeStyle="rgb(168,168,168)";ag.beginPath();ag.moveTo(ai.p1.x,ai.p1.y);ag.lineTo(ai.p2.x,ai.p2.y);ag.stroke()},shot:function(aj,ah){var ai=O.xxg(O.xxb(ah.p1,ah.p2),O.xxb(aj.p1,aj.p2));var ag=2*(Math.atan2(aj.p2.x-aj.p1.x,aj.p2.y-aj.p1.y)+Math.PI/2)-Math.atan2(ah.p2.x-ah.p1.x,ah.p2.y-ah.p1.y);ah.p1=ai;ah.p2=O.xxa(ai.x-Math.sin(ag),ai.y-Math.cos(ag))}};l.lens={p_name:"焦距(px)",xxo:-1000,xxp:1000,xxq:1,xxr:function(ag){return{type:"lens",p1:ag,p2:O.xxa(ag.x+p,ag.y),p:100}},xxs:l.lineobj.xxs,xxt:l.lineobj.xxt,xxu:l.lineobj.xxu,xxv:l.lineobj.xxv,xxw:l.lineobj.xxw,xxx:l.lineobj.xxx,xxy:l.lineobj.xxy,xxn:function(ai,ah){var ag=ah.getContext("2d");ag.strokeStyle="rgba(192,192,192,0.5)";ag.lineWidth=5;ag.lineCap="round";ag.beginPath();ag.moveTo(ai.p1.x,ai.p1.y);ag.lineTo(ai.p2.x,ai.p2.y);ag.stroke();ag.lineWidth=1;ag.lineCap="butt"},shot:function(al,aq){var ao=O.xxg(O.xxb(aq.p1,aq.p2),O.xxb(al.p1,al.p2));var ar=O.xxm(al);var at=O.xxl(al);var ai=O.xxg(ar,O.parallel(O.xxb(al.p1,al.p2),aq.p1));var ah=O.length(ai,at);var ag=(ah*al.p)/(ah-al.p);var an=(ag*O.length(ai,aq.p1))/ah;var aj=O.xxg(ar,O.xxf(at,Math.abs(ag)));var ap=((ag>0)==(O.length(aj[1],ai)<O.length(aj[2],ai)))?aj[2]:aj[1];var ak=O.xxg(O.parallel(O.xxb(al.p1,al.p2),ap),O.xxf(ap,Math.abs(an)));var au=O.xxb(ao,((an>0)==(O.length(ak[1],aq.p1)>O.length(ak[2],aq.p1)))?ak[1]:ak[2]);var am=Math.atan2((au.p2.x-au.p1.x),(au.p2.y-au.p1.y));if(ag>0){aq.p1=ao;aq.p2=O.xxa(au.p1.x+Math.sin(am),au.p1.y+Math.cos(am))}else{aq.p1=ao;aq.p2=O.xxa(au.p1.x-Math.sin(am),au.p1.y-Math.cos(am))}}};l.blackline={xxr:function(ag){return{type:"blackline",p1:ag,p2:O.xxa(ag.x+p,ag.y)}},xxs:l.lineobj.xxs,xxt:l.lineobj.xxt,xxu:l.lineobj.xxu,xxv:l.lineobj.xxv,xxw:l.lineobj.xxw,xxx:l.lineobj.xxx,xxy:l.lineobj.xxy,xxn:function(ai,ah){var ag=ah.getContext("2d");ag.strokeStyle="rgb(64,64,64)";ag.beginPath();ag.moveTo(ai.p1.x,ai.p1.y);ag.lineTo(ai.p2.x,ai.p2.y);ag.stroke()},shot:function(ah,ag){ag.exist=false}};l.radiant={p_name:"亮度",xxo:0,xxp:1,xxq:0.01,xxr:function(ag){return{type:"radiant",x:ag.x,y:ag.y,p:0.5}},xxs:function(ah,ag){ad()},xxt:function(ah,ag){},xxu:function(ah,ag){R=false},xxn:function(ai,ah){var ag=ah.getContext("2d");ag.fillStyle="rgb(0,255,0)";ag.fillRect(ai.x-2,ai.y-2,5,5)},xxv:function(ai,ah,ag){ai.x=ai.x+ah;ai.y=ai.y+ag;return ai},xxw:function(ah,ag){if(S(ag,ah)){return true}return false},xxx:function(ai,ag,ah){ai.x=ag.x;ai.y=ag.y;return{obj:ai}},xxz:function(aj){var ai=Math.PI*2/parseInt(n()*500);for(var ah=0;ah<(Math.PI*2-0.00001);ah=ah+ai){var ag=O.xxc(O.xxa(aj.x,aj.y),O.xxa(aj.x+Math.sin(ah),aj.y+Math.cos(ah)));ag.brightness=Math.min(aj.p/n(),1);ag.isNew=true;if(ah==0){ag.gap=true}t(ag)}}};l.parallel={p_name:"亮度",xxo:0,xxp:1,xxq:0.01,xxr:function(ag){return{type:"parallel",p1:ag,p2:O.xxa(ag.x+p,ag.y),p:0.5}},xxs:l.lineobj.xxs,xxt:l.lineobj.xxt,xxu:l.lineobj.xxu,xxv:l.lineobj.xxv,xxw:l.lineobj.xxw,xxx:l.lineobj.xxx,xxn:function(aj,ai){var ah=ai.getContext("2d");var ag=Math.atan2(aj.p1.x-aj.p2.x,aj.p1.y-aj.p2.y)-Math.PI/2;ah.strokeStyle="rgb(0,255,0)";ah.lineWidth=4;ah.lineCap="butt";ah.beginPath();ah.moveTo(aj.p1.x+Math.sin(ag)*2,aj.p1.y+Math.cos(ag)*2);ah.lineTo(aj.p2.x+Math.sin(ag)*2,aj.p2.y+Math.cos(ag)*2);ah.stroke();ah.strokeStyle="rgba(128,128,128,255)";ah.lineWidth=2;ah.beginPath();ah.moveTo(aj.p1.x,aj.p1.y);ah.lineTo(aj.p2.x,aj.p2.y);ah.stroke();ah.lineWidth=1;ah.lineCap="butt"},xxz:function(ak){var ah=Math.atan2(ak.p1.x-ak.p2.x,ak.p1.y-ak.p2.y)-Math.PI/2;var al=O.xxk(ak)*n();var aj=(ak.p2.x-ak.p1.x)/al;var ai=(ak.p2.y-ak.p1.y)/al;for(i=0;i<=al;i++){x=ak.p1.x+i*aj;y=ak.p1.y+i*ai;var ag=O.xxc(O.xxa(x,y),O.xxa(x+Math.sin(ah),y+Math.cos(ah)));ag.brightness=Math.min(ak.p/n(),1);ag.isNew=true;if(i==0){ag.gap=true}t(ag)}}};l.arcmirror={xxr:function(ag){return{type:"arcmirror",p1:ag}},xxs:function(ah,ag){if(!ah.p2&&!ah.p3){ad();ah.p2=ag;return}if(ah.p2&&!ah.p3){ah.p2=ag;ad();ah.p3=ag;return}},xxt:function(ah,ag){if(!ah.p3&&Math.sqrt(Math.pow(ah.p1.x-ag.x,2)+Math.pow(ah.p1.y-ag.y,2))>=5){ah.p2=ag;ad();return}if(ah.p3&&Math.sqrt(Math.pow(ah.p2.x-ag.x,2)+Math.pow(ah.p2.y-ag.y,2))>=5){ah.p3=ag;ad();return}},xxu:function(ah,ag){if(ah.p2&&!ah.p3&&Math.sqrt(Math.pow(ah.p1.x-ag.x,2)+Math.pow(ah.p1.y-ag.y,2))>=5){ah.p3=ag;return}if(ah.p3&&Math.sqrt(Math.pow(ah.p2.x-ag.x,2)+Math.pow(ah.p2.y-ag.y,2))>=5){ah.p3=ag;ad();R=false;return}},xxn:function(am,ak){var aj=ak.getContext("2d");aj.fillStyle="rgb(255,0,255)";if(am.p3&&am.p2){var ah=O.xxh(O.xxm(O.xxb(am.p1,am.p3)),O.xxm(O.xxb(am.p2,am.p3)));var al=O.length(ah,am.p3);var ai=Math.atan2(am.p1.y-ah.y,am.p1.x-ah.x);var ag=Math.atan2(am.p2.y-ah.y,am.p2.x-ah.x);var an=Math.atan2(am.p3.y-ah.y,am.p3.x-ah.x);aj.strokeStyle="rgb(168,168,168)";aj.beginPath();aj.arc(ah.x,ah.y,al,ai,ag,(ag<an&&an<ai)||(ai<ag&&ag<an)||(an<ai&&ai<ag));aj.stroke();aj.fillRect(am.p3.x-2,am.p3.y-2,3,3);aj.fillStyle="rgb(255,0,0)";aj.fillRect(am.p1.x-2,am.p1.y-2,3,3);aj.fillRect(am.p2.x-2,am.p2.y-2,3,3)}else{if(am.p2){aj.fillStyle="rgb(255,0,0)";aj.fillRect(am.p1.x-2,am.p1.y-2,3,3);aj.fillRect(am.p2.x-2,am.p2.y-2,3,3)}else{aj.fillStyle="rgb(255,0,0)";aj.fillRect(am.p1.x-2,am.p1.y-2,3,3)}}},xxv:function(ai,ah,ag){ai.p1.x=ai.p1.x+ah;ai.p1.y=ai.p1.y+ag;ai.p2.x=ai.p2.x+ah;ai.p2.y=ai.p2.y+ag;ai.p3.x=ai.p3.x+ah;ai.p3.y=ai.p3.y+ag;return ai},xxw:function(am,an,ao){if(S(an,am.p1)){ao.part=1;return true}if(S(an,am.p2)){ao.part=2;return true}if(S(an,am.p3)){ao.part=3;return true}var ai=O.xxh(O.xxm(O.xxb(am.p1,am.p3)),O.xxm(O.xxb(am.p2,am.p3)));var ah=O.length(ai,am.p3);var ak=Math.atan2(am.p1.y-ai.y,am.p1.x-ai.x);var aj=Math.atan2(am.p2.y-ai.y,am.p2.x-ai.x);var ag=Math.atan2(am.p3.y-ai.y,am.p3.x-ai.x);var al=Math.atan2(an.y-ai.y,an.x-ai.x);if(Math.abs(O.length(ai,an)-ah)<8&&(((aj<ag&&ag<ak)||(ak<aj&&aj<ag)||(ag<ak&&ak<aj))==((aj<al&&al<ak)||(ak<aj&&aj<al)||(al<ak&&ak<aj)))){ao.part=0;ao.mouse1=an;return true}return false},xxx:function(ak,ag,aj){if(aj.part==1){ak.p1=ag}if(aj.part==2){ak.p2=ag}if(aj.part==3){ak.p3=ag}if(aj.part==0){var ai=aj.mouse1.x-ag.x;var ah=aj.mouse1.y-ag.y;ak.p1.x=ak.p1.x-ai;ak.p1.y=ak.p1.y-ah;ak.p2.x=ak.p2.x-ai;ak.p2.y=ak.p2.y-ah;ak.p3.x=ak.p3.x-ai;ak.p3.y=ak.p3.y-ah;aj.mouse1=ag}},xxy:function(an,ao){if(!an.p3){return}var ai=O.xxh(O.xxm(O.xxb(an.p1,an.p3)),O.xxm(O.xxb(an.p2,an.p3)));var ah=O.length(ai,an.p3);var ak=Math.atan2(an.p1.y-ai.y,an.p1.x-ai.x);var aj=Math.atan2(an.p2.y-ai.y,an.p2.x-ai.x);var ag=Math.atan2(an.p3.y-ai.y,an.p3.x-ai.x);var aq=O.xxi(O.xxb(ao.p1,ao.p2),O.xxf(ai,an.p2));var ap;var al=[];var ar=[];for(var am=1;am<=2;am++){ap=Math.atan2(aq[am].y-ai.y,aq[am].x-ai.x);al[am]=(((aj<ag&&ag<ak)||(ak<aj&&aj<ag)||(ag<ak&&ak<aj))==((aj<ap&&ap<ak)||(ak<aj&&aj<ap)||(ap<ak&&ak<aj)))&&((O.length(aq[am],ao.p1)>O.length(aq[am],ao.p2)));ar[am]=O.length(ao.p1,aq[am])}if(al[1]&&((!al[2])||ar[1]<ar[2])){return aq[1]}if(al[2]&&((!al[1])||ar[2]<ar[1])){return aq[2]}},shot:function(ak,ai){var ag=O.xxh(O.xxm(O.xxb(ak.p1,ak.p3)),O.xxm(O.xxb(ak.p2,ak.p3)));var aj=this.xxy(ak,ai);var ah=2*(-Math.atan2(ag.y-aj.y,ag.x-aj.x)+Math.PI/2)-Math.atan2(ai.p2.x-ai.p1.x,ai.p2.y-ai.p1.y);ai.p1=aj;ai.p2=O.xxa(aj.x-Math.sin(ah),aj.y-Math.cos(ah))}};var h;var J;var B=[];var o=0;var R=false;var d=-1;var T={};var A=-1;var C="";var G=[];var X=0;var P=0.1;var af=1;var D=false;var b=true;var p=20;var s=[];var w=0;var j=20;var f=0;var E=0;var M;var m="light";var z=-1;var aa=false;var Q=false;var e=false;var N=-1;var ac=false;window.onload=function(ag){h=document.getElementById("canvas1");h.width=window.innerWidth;h.height=window.innerHeight;H(C);if(document.getElementById("textarea1").value!=""){q()}else{U(m)}s[0]=document.getElementById("textarea1").value;document.getElementById("undo").disabled=true;document.getElementById("redo").disabled=true;h.onmousedown=function(ah){document.body.focus();Z(ah);return false};h.onmousemove=function(ah){a(ah)};h.onmouseup=function(ah){k(ah)};h.ontouchstart=function(ah){document.body.focus();Z(ah)};h.ontouchmove=function(ah){a(ah);ah.preventDefault()};h.ontouchend=function(ah){k(ah);ah.preventDefault()};h.ontouchcancel=function(ah){k(ah);F();ah.preventDefault()};document.getElementById("tool_laser").onclick=function(){H("laser")};document.getElementById("tool_radiant").onclick=function(){H("radiant")};document.getElementById("tool_parallel").onclick=function(){H("parallel")};document.getElementById("tool_mirror").onclick=function(){H("mirror")};document.getElementById("tool_arcmirror").onclick=function(){H("arcmirror")};document.getElementById("tool_lens").onclick=function(){H("lens")};document.getElementById("tool_refractor").onclick=function(){H("refractor")};document.getElementById("tool_blackline").onclick=function(){H("blackline")};document.getElementById("tool_").onclick=function(){H("")};document.getElementById("undo").onclick=F;document.getElementById("redo").onclick=r;document.getElementById("cleanAll").onclick=V;document.getElementById("accessJSON").onclick=u;document.getElementById("mode_light").onclick=function(){U("light")};document.getElementById("mode_extended_light").onclick=function(){U("extended_light")};document.getElementById("mode_images").onclick=function(){U("images")};document.getElementById("mode_observer").onclick=function(){U("observer")};document.getElementById("rayDensity").onchange=function(){K(Math.exp(this.value));ad()};document.getElementById("rayDensity").onmouseup=function(){g()};document.getElementById("rayDensity").ontouchend=function(){g()};document.getElementById("forceStop").onclick=function(){if(z!=-1){e=true}};document.getElementById("objAttr_range").onchange=function(){W(document.getElementById("objAttr_range").value)};document.getElementById("objAttr_range").onmouseup=function(){g()};document.getElementById("objAttr_range").ontouchend=function(){g()};document.getElementById("objAttr_text").onchange=function(){W(document.getElementById("objAttr_text").value)};document.getElementById("setAttrAll").onchange=function(){W(document.getElementById("objAttr_text").value);g()};document.getElementById("copy").onclick=function(){B[B.length]=JSON.parse(JSON.stringify(B[A]));ad();g()};document.getElementById("delete").onclick=function(){ae(A);ad();g()};document.getElementById("textarea1").onchange=function(){q();g()}};function ad(){ac=true;document.getElementById("forceStop").style.display="none";if(z!=-1){clearTimeout(z);z=-1;aa=false}if(!aa){aa=true;v()}}function v(){if(!ac){aa=false;return}ac=false;c();L.cls(h);Q=false;G=[];shotRayCount=0;for(var ah=0;ah<B.length;ah++){l[B[ah].type].xxn(B[ah],h);if(l[B[ah].type].xxz){l[B[ah].type].xxz(B[ah])}}ab();if(m=="observer"){var ag=h.getContext("2d");ag.globalAlpha=1;ag.beginPath();ag.fillStyle="blue";ag.arc(M.c.x,M.c.y,M.r,0,Math.PI*2,false);ag.fill()}N=new Date()}function t(ag){G[G.length]=ag}function n(){if(m=="images"||m=="observer"){return af}else{return P}}function ab(){z=-1;var au=new Date();var aq=1;h.getContext("2d").globalAlpha=aq;var ax;var ah;var ag;var aA;var ao;var av;var al;var am;var az;var ap=G.length;while(ap!=0&&!e){if(new Date()-au>200){document.getElementById("status").innerHTML=shotRayCount+"段光線(等待區還有"+ap+"條)";Q=true;z=setTimeout(ab,10);document.getElementById("forceStop").style.display="";return}ap=0;al=-1;ag=null;aA=null;for(var at=0;at<G.length;at++){if(G[at]&&G[at].exist){ao=null;av=-1;am=null;az=Infinity;ah=false;for(var aw=0;aw<B.length;aw++){if(l[B[aw].type].xxy){var ay=l[B[aw].type].xxy(B[aw],G[at]);if(typeof ay!="undefined"){var ak=O.length(G[at].p1,ay);if(ak<az&&ak>0.00001){ao=B[aw];av=aw;am=ay;az=ak}}}}h.getContext("2d").globalAlpha=aq*G[at].brightness;if(az==Infinity){if(m=="light"||m=="extended_light"){L.xxn(G[at],h,"rgb(255,255,128)")}if(m=="extended_light"&&!G[at].isNew){L.xxn(O.xxc(G[at].p1,O.xxa(G[at].p1.x*2-G[at].p2.x,G[at].p1.y*2-G[at].p2.y)),h,"rgb(255,128,0)")}if(m=="observer"){var an=O.xxi(G[at],M);if(an[1]){if(O.length(an[1],G[at].p1)>O.length(an[1],G[at].p2)){ah=true}}}}else{if(m=="light"||m=="extended_light"){L.xxn(O.xxe(G[at].p1,am),h,"rgb(255,255,128)")}if(m=="extended_light"&&!G[at].isNew){L.xxn(O.xxc(G[at].p1,O.xxa(G[at].p1.x*2-G[at].p2.x,G[at].p1.y*2-G[at].p2.y)),h,"rgb(255,128,0)");L.xxn(O.xxc(am,O.xxa(am.x*2-G[at].p2.x,am.y*2-G[at].p2.y)),h,"rgb(80,80,80)")}if(m=="observer"){var an=O.xxi(G[at],M);if(an[1]){if(O.length(G[at].p1,an[1])+O.length(an[1],am)-O.length(G[at].p1,am)<1e-7){ah=true}}}}if(m=="observer"&&ag){if(!G[at].gap){var aj=O.xxh(G[at],ag);if(ah){if(aA&&O.length(aA,aj)<5){if((O.length(aj,G[at].p1)+O.length(aj,an[1])-O.length(G[at].p1,an[1])<1e-7||O.length(aj,G[at].p1)<O.length(aj,an[1]))&&aA){h.getContext("2d").globalAlpha=aq*(G[at].brightness+ag.brightness)*0.5;var ai=(aj.x-G[at].p1.x)*(G[at].p2.x-G[at].p1.x)+(aj.y-G[at].p1.y)*(G[at].p2.y-G[at].p1.y);if(ai<0){L.xxn(aj,h,"rgb(255,128,0)")}else{if(ai<az){L.xxn(aj,h,"rgb(255,255,128)")}}L.xxn(O.xxe(an[1],aj),h,"rgb(0,0,255)")}else{L.xxn(O.xxc(an[1],G[at].p1),h,"rgb(0,0,255)")}}else{L.xxn(O.xxc(an[1],G[at].p1),h,"rgb(0,0,255)")}}aA=aj}else{aA=null}}if(m=="images"&&ag){if(!G[at].gap){var aj=O.xxh(G[at],ag);if(aA&&O.length(aA,aj)<5){h.getContext("2d").globalAlpha=aq*(G[at].brightness+ag.brightness)*0.5;var ai=(aj.x-G[at].p1.x)*(G[at].p2.x-G[at].p1.x)+(aj.y-G[at].p1.y)*(G[at].p2.y-G[at].p1.y);if(ai<0){L.xxn(aj,h,"rgb(255,128,0)")}else{if(ai<az){L.xxn(aj,h,"rgb(255,255,128)")}else{L.xxn(aj,h,"rgb(80,80,80)")}}}aA=aj}}if(al!=av){G[at].gap=true}G[at].isNew=false;ag={p1:G[at].p1,p2:G[at].p2};al=av;if(ao){l[ao.type].shot(ao,G[at])}else{G[at]=null}shotRayCount=shotRayCount+1;if(G[at]&&G[at].exist){ap=ap+1}}}}h.getContext("2d").globalAlpha=1;for(var aw=0;aw<B.length;aw++){l[B[aw].type].xxn(B[aw],h)}if(m=="observer"){var ar=h.getContext("2d");ar.globalAlpha=1;ar.beginPath();ar.fillStyle="blue";ar.arc(M.c.x,M.c.y,M.r,0,Math.PI*2,false);ar.fill()}if(e){document.getElementById("status").innerHTML=shotRayCount+"段光線(強迫停止)";e=false}else{if(Q){document.getElementById("status").innerHTML=shotRayCount+"段光線"}else{document.getElementById("status").innerHTML=shotRayCount+"段光線,費時"+(new Date()-au)+"ms"}}document.getElementById("forceStop").style.display="none";setTimeout(v,10)}function S(ah,ag){return Math.sqrt(Math.pow(ag.x-ah.x,2)+Math.pow(ag.y-ah.y,2))<15}function Y(ag,ah){return O.length(ag,ah.p1)+O.length(ag,ah.p2)-O.xxk(ah)<2}function Z(ai){if(document.getElementById("grid").checked!=ai.ctrlKey){J=O.xxa(Math.round((ai.pageX-ai.target.offsetLeft)/p)*p,Math.round((ai.pageY-ai.target.offsetTop)/p)*p)}else{J=O.xxa(ai.pageX-ai.target.offsetLeft,ai.pageY-ai.target.offsetTop)}if(R){l[B[B.length-1].type].xxs(B[B.length-1],J)}else{if(m=="observer"){if(O.length(J,M.c)<M.r){d=-4;return}}var ah;if((document.getElementById("dragObj").checked!=ai.altKey)&&!ai.shiftKey){for(var ag=0;ag<B.length;ag++){if(typeof B[ag]!="undefined"){if(l[B[ag].type].xxw(B[ag],J,T)){I(ag);d=ag;return}}}}if(d==-1){if((C=="")||ai.shiftKey){d=-3;T={mouse1:J};document.getElementById("obj_settings").style.display="none"}else{B[B.length]=l[C].xxr(J);R=true;if(B[A]){if(B[A].type==B[B.length-1].type){B[B.length-1].p=B[A].p}}I(B.length-1);l[B[B.length-1].type].xxs(B[B.length-1],J)}}}}function a(al){if(document.getElementById("grid").checked!=al.ctrlKey){J=O.xxa(Math.round((al.pageX-al.target.offsetLeft)/p)*p,Math.round((al.pageY-al.target.offsetTop)/p)*p)}else{J=O.xxa(al.pageX-al.target.offsetLeft,al.pageY-al.target.offsetTop)}if(R){l[B[B.length-1].type].xxt(B[B.length-1],J)}else{var ag=m=="observed_light"||m=="observed_images";if(d==-4){M.c=J;ad()}var ak;if(d>=0){l[B[d].type].xxx(B[d],J,T);ad()}if(d==-3){var aj=J.x-T.mouse1.x;var ai=J.y-T.mouse1.y;for(var ah=0;ah<B.length;ah++){l[B[ah].type].xxv(B[ah],aj,ai)}T.mouse1=J;if(M){M.c.x+=aj;M.c.y+=ai}ad()}}}function k(ag){if(R){l[B[B.length-1].type].xxu(B[B.length-1],J);if(!R){g()}}else{d=-1;T={};g()}}window.onresize=function(ag){h.width=window.innerWidth;h.height=window.innerHeight;ad()};function I(ah){if(ah<0||ah>=B.length){A=-1;document.getElementById("obj_settings").style.display="none";return}A=ah;document.getElementById("obj_name").innerHTML=document.getElementById("tool_"+B[ah].type).value;if(l[B[ah].type].p_name){document.getElementById("p_box").style.display="";var ag=B[ah].p;document.getElementById("p_name").innerHTML=l[B[ah].type].p_name;document.getElementById("objAttr_range").min=l[B[ah].type].xxo;document.getElementById("objAttr_range").max=l[B[ah].type].xxp;document.getElementById("objAttr_range").step=l[B[ah].type].xxq;document.getElementById("objAttr_range").value=ag;document.getElementById("objAttr_text").value=ag;B[ah].p=ag;for(var ai=0;ai<B.length;ai++){if(ai!=A&&B[ai].type==B[A].type){document.getElementById("setAttrAll_box").style.display="";break}if(ai==B.length-1){document.getElementById("setAttrAll_box").style.display="none"}}}else{document.getElementById("p_box").style.display="none"}document.getElementById("obj_settings").style.display=""}function W(ah){B[A].p=ah;document.getElementById("objAttr_text").value=ah;document.getElementById("objAttr_range").value=ah;if(document.getElementById("setAttrAll").checked){for(var ag=0;ag<B.length;ag++){if(B[ag].type==B[A].type){B[ag].p=ah}}}ad()}function ae(ag){for(var ah=ag;ah<B.length-1;ah++){B[ah]=JSON.parse(JSON.stringify(B[ah+1]))}R=false;B.length=B.length-1;A--;I(A)}function g(){w=(w+1)%j;f=w;document.getElementById("undo").disabled=false;document.getElementById("redo").disabled=true;s[w]=document.getElementById("textarea1").value;if(f==E){E=(E+1)%j}}function F(){if(R){R=false;B.length--;I(-1);ad();return}w=(w+(j-1))%j;document.getElementById("textarea1").value=s[w];q();document.getElementById("redo").disabled=false;if(w==E){document.getElementById("undo").disabled=true}}function r(){R=false;w=(w+1)%j;document.getElementById("textarea1").value=s[w];q();document.getElementById("undo").disabled=false;if(w==f){document.getElementById("redo").disabled=true}}function V(){R=false;B.length=0;I(-1);ad();g()}window.onkeydown=function(ag){if(ag.ctrlKey&&ag.keyCode==90){F();return false}if(ag.ctrlKey&&ag.keyCode==68){B[B.length]=JSON.parse(JSON.stringify(B[A]));ad();g();return false}if(ag.altKey&&ag.keyCode==78){V();return false}if(ag.keyCode==46){ae(A);ad();g();return false}};function c(){document.getElementById("textarea1").value=JSON.stringify({objs:B,mode:m,rayDensity_light:P,rayDensity_images:af,observer:M})}function q(){jsonData=JSON.parse(document.getElementById("textarea1").value);B=jsonData.objs;P=jsonData.rayDensity_light;af=jsonData.rayDensity_images;M=jsonData.observer;U(jsonData.mode);I(A)}function u(){if(document.getElementById("textarea1").style.display=="none"){document.getElementById("textarea1").style.display="";document.getElementById("textarea1").select()}else{document.getElementById("textarea1").style.display="none"}}function H(ag){document.getElementById("tool_"+C).style.backgroundColor="#E9E9E9";document.getElementById("tool_"+ag).style.backgroundColor="#C0C0C0";C=ag}function U(ag){document.getElementById("mode_"+m).style.backgroundColor="#E9E9E9";document.getElementById("mode_"+ag).style.backgroundColor="#C0C0C0";m=ag;if(m=="images"||m=="observer"){document.getElementById("rayDensity").value=Math.log(af)}else{document.getElementById("rayDensity").value=Math.log(P)}if(m=="observer"&&!M){M=O.xxf(O.xxa(h.width*0.5,h.height*0.5),20)}ad()}function K(ag){if(m=="images"||m=="observer"){af=ag}else{P=ag}}})();
//(function(){var O={xxa:function(ag,ah){return{type:"xxa",x:ag,y:ah,exist:true}},xxb:function(ah,ag){return{type:"xxb",p1:ah,p2:ag,exist:true}},xxc:function(ah,ag){return{type:"xxc",p1:ah,p2:ag,exist:true}},xxd:function(ah,ag){return{type:"xxd",p1:ah,p2:ag,exist:true}},xxe:function(ah,ag){return{type:"xxd",p1:ah,p2:ag,exist:true}},xxf:function(ah,ag){if(typeof ag=="object"&&ag.type=="xxa"){return{type:"xxf",c:ah,r:this.xxd(ah,ag),exist:true}}else{return{type:"xxf",c:ah,r:ag,exist:true}}},xxg:function(ah,ag){if(ah.type=="xxb"&&ag.type=="xxb"){return this.xxh(ah,ag)}if(ah.type=="xxb"&&ag.type=="xxf"){return this.xxi(ah,ag)}if(ah.type=="xxf"&&ag.type=="xxb"){return this.xxi(ag,ah)}if(ah.type=="xxf"&&ag.type=="xxf"){return this.xxj(ah,ag)}},xxh:function(ak,ai){var aj,ah,an,al,ag,am;if(Math.abs(ak.p2.x-ak.p1.x)<1e-8){ah=ak.p1.x;an=(ai.p2.y-ai.p1.y)/(ai.p2.x-ai.p1.x);al=ai.p1.y-an*(ai.p1.x);ag=ah;am=an*ah+al}if(Math.abs(ai.p2.x-ai.p1.x)<1e-8){aj=(ak.p2.y-ak.p1.y)/(ak.p2.x-ak.p1.x);ah=ak.p1.y-aj*(ak.p1.x);al=ai.p1.x;ag=al;am=aj*al+ah}if(!(Math.abs(ak.p2.x-ak.p1.x)<1e-8)&&!(Math.abs(ai.p2.x-ai.p1.x)<1e-8)){aj=(ak.p2.y-ak.p1.y)/(ak.p2.x-ak.p1.x);ah=ak.p1.y-aj*(ak.p1.x);an=(ai.p2.y-ai.p1.y)/(ai.p2.x-ai.p1.x);al=ai.p1.y-an*(ai.p1.x);ag=(al-ah)/(aj-an);am=aj*ag+ah}return O.xxa(ag,am)},xxi:function(ak,al){var at,aq,ao,an,am,aj,ai,ag;var ar=new Array();var ap=new Array();var ah=new Array();if(Math.abs(ak.p2.x-ak.p1.x)<1e-8){aq=ak.p1.x;ao=al.c.x;an=al.c.y;am=(typeof al.r=="object")?(Math.sqrt(Math.pow(al.r.p1.x-al.r.p2.x,2)+Math.pow(al.r.p1.y-al.r.p2.y,2))):(al.r);ar[1]=aq;ar[2]=aq;ap[1]=(2*an+Math.sqrt(Math.pow(2*an,2)-4*(Math.pow(ar[1]-ao,2)+Math.pow(an,2)-Math.pow(am,2))))/2;ap[2]=(2*an-Math.sqrt(Math.pow(2*an,2)-4*(Math.pow(ar[2]-ao,2)+Math.pow(an,2)-Math.pow(am,2))))/2}else{at=(ak.p2.y-ak.p1.y)/(ak.p2.x-ak.p1.x);aq=ak.p1.y-at*(ak.p1.x);ao=al.c.x;an=al.c.y;am=(typeof al.r=="object")?(Math.sqrt(Math.pow(al.r.p1.x-al.r.p2.x,2)+Math.pow(al.r.p1.y-al.r.p2.y,2))):(al.r);aj=1+Math.pow(at,2);ai=-2*ao+2*at*aq-2*an*at;ag=Math.pow(ao,2)+Math.pow(aq,2)-2*an*aq+Math.pow(an,2)-Math.pow(am,2);ar[1]=(-ai+Math.sqrt(Math.pow(ai,2)-4*aj*ag))/(2*aj);ar[2]=(-ai-Math.sqrt(Math.pow(ai,2)-4*aj*ag))/(2*aj);ap[1]=at*ar[1]+aq;ap[2]=at*ar[2]+aq}ah[1]=O.xxa(ar[1],ap[1]);ah[2]=O.xxa(ar[2],ap[2]);return ah},xxj:function(am,al){var av,at,aq,ap,ao,an,ak,aj,ah,ag,aw;var au=new Array();var ar=new Array();var ai=new Array();av=am.c.x;at=am.c.y;aq=(typeof am.r=="object")?(Math.sqrt(Math.pow(am.r.p1.x-am.r.p2.x,2)+Math.pow(am.r.p1.y-am.r.p2.y,2))):(am.r);ap=al.c.x;ao=al.c.y;an=(typeof al.r=="object")?(Math.sqrt(Math.pow(al.r.p1.x-al.r.p2.x,2)+Math.pow(al.r.p1.y-al.r.p2.y,2))):(al.r);ak=(2*ao-2*at)/(2*ap-2*av);aj=(-Math.pow(av,2)-Math.pow(at,2)+Math.pow(aq,2)+Math.pow(ap,2)+Math.pow(ao,2)-Math.pow(an,2))/(2*ap-2*av);if(Math.abs(ap-av)<1e-8){ak=(Math.pow(av,2)+Math.pow(at,2)-Math.pow(aq,2)-Math.pow(ap,2)-Math.pow(ao,2)+Math.pow(an,2))/(2*ao-2*at);ah=1;ag=-2*av;aw=Math.pow(ak,2)+2*at*ak+Math.pow(av,2)+Math.pow(at,2)-Math.pow(aq,2);ar[1]=-ak;ar[2]=-ak;au[1]=(-ag+Math.sqrt(Math.pow(ag,2)-4*ah*aw))/(2*ah);au[2]=(-ag-Math.sqrt(Math.pow(ag,2)-4*ah*aw))/(2*ah)}else{ak=(2*ao-2*at)/(2*ap-2*av);aj=(-Math.pow(av,2)-Math.pow(at,2)+Math.pow(aq,2)+Math.pow(ap,2)+Math.pow(ao,2)-Math.pow(an,2))/(2*ap-2*av);ah=Math.pow(ak,2)+1;ag=2*(-ak)*aj-2*av*(-ak)-2*at;aw=Math.pow(aj,2)-2*av*aj+Math.pow(av,2)+Math.pow(at,2)-Math.pow(aq,2);ar[1]=(-ag+Math.sqrt(Math.pow(ag,2)-4*ah*aw))/(2*ah);ar[2]=(-ag-Math.sqrt(Math.pow(ag,2)-4*ah*aw))/(2*ah);au[1]=(-ak)*ar[1]+aj;au[2]=(-ak)*ar[2]+aj}ai[1]=O.xxa(au[1],ar[1]);ai[2]=O.xxa(au[2],ar[2]);return ai},xxk:function(ag){return Math.sqrt(Math.pow(ag.p1.x-ag.p2.x,2)+Math.pow(ag.p1.y-ag.p2.y,2))},length:function(ah,ag){return Math.sqrt(Math.pow(ah.x-ag.x,2)+Math.pow(ah.y-ag.y,2))},xxl:function(ah){var ag=O.xxj(O.xxf(ah.p1,ah.p2),O.xxf(ah.p2,ah.p1));return O.xxh(ah,O.xxb(ag[1],ag[2]))},xxm:function(ah){var ag=O.xxj(O.xxf(ah.p1,ah.p2),O.xxf(ah.p2,ah.p1));return O.xxb(ag[1],ag[2])},parallel:function(ag,al){var ak=O.xxf(ag.p1,al);var am=O.xxg(ag,ak)[1];var aj=O.xxf(am,ag.p1);var ai=O.xxf(al,ag.p1);var ah=O.xxg(aj,ai);if(Math.abs(ah[2].x-ag.p1.x)<0.00001&&Math.abs(ah[2].y-ag.p1.y)<0.00001){return O.xxb(ah[1],al)}else{return O.xxb(ah[2],al)}}};var L={xxn:function(ak,aj,ah){var ag=aj.getContext("2d");if(ak.type=="xxa"){if(typeof ah=="undefined"){ag.fillStyle="red"}else{ag.fillStyle=ah}ag.fillRect(ak.x-2,ak.y-2,5,5)}if(ak.type=="xxb"){if(typeof ah=="undefined"){ag.strokeStyle="black"}else{ag.strokeStyle=ah}ag.beginPath();al=Math.atan2((ak.p2.x-ak.p1.x),(ak.p2.y-ak.p1.y));ai=Math.abs(ak.p1.x)+Math.abs(ak.p1.y)+aj.height+aj.width;ag.moveTo(ak.p1.x-Math.sin(al)*ai,ak.p1.y-Math.cos(al)*ai);ag.lineTo(ak.p1.x+Math.sin(al)*ai,ak.p1.y+Math.cos(al)*ai);ag.stroke()}if(ak.type=="xxc"){if(typeof ah=="undefined"){ag.strokeStyle="black"}else{ag.strokeStyle=ah}var al,ai;ag.beginPath();al=Math.atan2((ak.p2.x-ak.p1.x),(ak.p2.y-ak.p1.y));ai=Math.abs(ak.p1.x)+Math.abs(ak.p1.y)+aj.height+aj.width;ag.moveTo(ak.p1.x,ak.p1.y);ag.lineTo(ak.p1.x+Math.sin(al)*ai,ak.p1.y+Math.cos(al)*ai);ag.stroke()}if(ak.type=="xxd"){if(typeof ah=="undefined"){ag.strokeStyle="black"}else{ag.strokeStyle=ah}ag.beginPath();ag.moveTo(ak.p1.x,ak.p1.y);ag.lineTo(ak.p2.x,ak.p2.y);ag.stroke()}if(ak.type=="xxf"){if(typeof ah=="undefined"){ag.strokeStyle="black"}else{ag.strokeStyle=ah}ag.beginPath();if(typeof ak.r=="object"){ag.arc(ak.c.x,ak.c.y,Math.sqrt(Math.pow(ak.r.p1.x-ak.r.p2.x,2)+Math.pow(ak.r.p1.y-ak.r.p2.y,2)),0,Math.PI*2,false)}else{ag.arc(ak.c.x,ak.c.y,ak.r,0,Math.PI*2,false)}ag.stroke()}},cls:function(ah){var ag=ah.getContext("2d");ag.clearRect(0,0,ah.width,ah.height)}};var l={};l.lineobj={xxs:function(ah,ag){ah.p2=ag;if(Math.sqrt(Math.pow(ah.p1.x-ag.x,2)+Math.pow(ah.p1.y-ag.y,2))>=5){ad()}},xxt:function(ah,ag){ah.p2=ag;if(Math.sqrt(Math.pow(ah.p1.x-ag.x,2)+Math.pow(ah.p1.y-ag.y,2))>=5){ad()}},xxu:function(ah,ag){if(Math.sqrt(Math.pow(ah.p1.x-ag.x,2)+Math.pow(ah.p1.y-ag.y,2))>=5){R=false}},xxv:function(ai,ah,ag){ai.p1.x=ai.p1.x+ah;ai.p1.y=ai.p1.y+ag;ai.p2.x=ai.p2.x+ah;ai.p2.y=ai.p2.y+ag},xxw:function(ai,ag,ah){if(S(ag,ai.p1)){ah.part=1;return true}if(S(ag,ai.p2)){ah.part=2;return true}if(Y(ag,ai)){ah.part=0;ah.mouse1=ag;return true}return false},xxx:function(ak,ag,aj){if(aj.part==1){ak.p1=ag}if(aj.part==2){ak.p2=ag}if(aj.part==0){var ai=aj.mouse1.x-ag.x;var ah=aj.mouse1.y-ag.y;ak.p1.x=ak.p1.x-ai;ak.p1.y=ak.p1.y-ah;ak.p2.x=ak.p2.x-ai;ak.p2.y=ak.p2.y-ah;aj.mouse1=ag}},xxy:function(ai,ag){var ah=O.xxg(O.xxb(ag.p1,ag.p2),O.xxb(ai.p1,ai.p2));if((O.xxk(O.xxe(ah,ai.p1))+O.xxk(O.xxe(ah,ai.p2))-O.xxk(ai)<1e-7)&&((O.xxk(O.xxe(ah,ag.p1))+O.xxk(O.xxe(ah,ag.p2))-O.xxk(ag)<1e-7)||(O.xxk(O.xxe(ah,ag.p1))>O.xxk(O.xxe(ah,ag.p2))))){return ah}}};l.refractor={p_name:"Refractive index",xxo:1,xxp:3,xxq:0.01,xxr:function(ag){return{type:"refractor",path:[{x:ag.x,y:ag.y,arc:false}],notDone:true,p:1.5}},xxs:function(ah,ag){if(ah.path.length>1){if(ah.path.length>3&&S(ag,ah.path[0])){ah.path.length--;ah.notDone=false;ad();return}ah.path[ah.path.length-1]={x:ag.x,y:ag.y};ah.path[ah.path.length-1].arc=true}},xxt:function(ah,ag){if(!ah.notDone){return}if(typeof ah.path[ah.path.length-1].arc!="undefined"){if(ah.path[ah.path.length-1].arc&&Math.sqrt(Math.pow(ah.path[ah.path.length-1].x-ag.x,2)+Math.pow(ah.path[ah.path.length-1].y-ag.y,2))>=5){ah.path[ah.path.length]=ag;ad()}}else{ah.path[ah.path.length-1]={x:ag.x,y:ag.y};ad()}},xxu:function(ah,ag){if(!ah.notDone){R=false;ad();return}if(ah.path.length>3&&S(ag,ah.path[0])){ah.path.length--;ah.notDone=false;R=false;ad();return}ah.path[ah.path.length-1]={x:ag.x,y:ag.y};ah.path[ah.path.length-1].arc=false;ah.path[ah.path.length]={x:ag.x,y:ag.y};ad()},xxn:function(am,al){var at=al.getContext("2d");if(am.notDone){at.beginPath();at.moveTo(am.path[0].x,am.path[0].y);for(var an=0;an<am.path.length-1;an++){if(am.path[(an+1)].arc&&!am.path[an].arc&&an<am.path.length-2){var ar=O.xxa(am.path[an].x,am.path[an].y);var aq=O.xxa(am.path[(an+2)].x,am.path[(an+2)].y);var ap=O.xxa(am.path[(an+1)].x,am.path[(an+1)].y);var ai=O.xxh(O.xxm(O.xxb(ar,ap)),O.xxm(O.xxb(aq,ap)));var ah=O.length(ai,ap);var ak=Math.atan2(ar.y-ai.y,ar.x-ai.x);var aj=Math.atan2(aq.y-ai.y,aq.x-ai.x);var ag=Math.atan2(ap.y-ai.y,ap.x-ai.x);var ao=(aj<ag&&ag<ak)||(ak<aj&&aj<ag)||(ag<ak&&ak<aj);at.arc(ai.x,ai.y,ah,ak,aj,ao)}else{if(!am.path[(an+1)].arc&&!am.path[an].arc){at.lineTo(am.path[(an+1)].x,am.path[(an+1)].y)}}}at.globalAlpha=1;at.strokeStyle="rgb(128,128,128)";at.lineWidth=1;at.stroke()}else{at.beginPath();at.moveTo(am.path[0].x,am.path[0].y);for(var an=0;an<am.path.length;an++){if(am.path[(an+1)%am.path.length].arc&&!am.path[an%am.path.length].arc){var ar=O.xxa(am.path[an%am.path.length].x,am.path[an%am.path.length].y);var aq=O.xxa(am.path[(an+2)%am.path.length].x,am.path[(an+2)%am.path.length].y);var ap=O.xxa(am.path[(an+1)%am.path.length].x,am.path[(an+1)%am.path.length].y);var ai=O.xxh(O.xxm(O.xxb(ar,ap)),O.xxm(O.xxb(aq,ap)));var ah=O.length(ai,ap);var ak=Math.atan2(ar.y-ai.y,ar.x-ai.x);var aj=Math.atan2(aq.y-ai.y,aq.x-ai.x);var ag=Math.atan2(ap.y-ai.y,ap.x-ai.x);var ao=(aj<ag&&ag<ak)||(ak<aj&&aj<ag)||(ag<ak&&ak<aj);at.arc(ai.x,ai.y,ah,ak,aj,ao)}else{if(!am.path[(an+1)%am.path.length].arc&&!am.path[an%am.path.length].arc){at.lineTo(am.path[(an+1)%am.path.length].x,am.path[(an+1)%am.path.length].y)}}}at.fillStyle="rgb(80,80,80)";at.globalAlpha=1-(1/am.p);at.fill();at.globalAlpha=1}at.lineWidth=1;for(var an=0;an<am.path.length;an++){if(typeof am.path[an].arc!="undefined"){if(am.path[an].arc){at.fillStyle="rgb(255,0,255)";at.fillRect(am.path[an].x-2,am.path[an].y-2,3,3)}else{at.fillStyle="rgb(255,0,0)";at.fillRect(am.path[an].x-2,am.path[an].y-2,3,3)}}}},xxv:function(aj,ah,ag){for(var ai=0;ai<aj.path.length;ai++){aj.path[ai].x+=ah;aj.path[ai].y+=ag}},xxw:function(am,ao,ar){for(var an=0;an<am.path.length;an++){if(S(ao,am.path[an])){ar.part=1;ar.index=an;return true}}for(var an=0;an<am.path.length;an++){if(am.path[(an+1)%am.path.length].arc&&!am.path[an%am.path.length].arc){var at=O.xxa(am.path[an%am.path.length].x,am.path[an%am.path.length].y);var aq=O.xxa(am.path[(an+2)%am.path.length].x,am.path[(an+2)%am.path.length].y);var ap=O.xxa(am.path[(an+1)%am.path.length].x,am.path[(an+1)%am.path.length].y);var ai=O.xxh(O.xxm(O.xxb(at,ap)),O.xxm(O.xxb(aq,ap)));var ah=O.length(ai,ap);var ak=Math.atan2(at.y-ai.y,at.x-ai.x);var aj=Math.atan2(aq.y-ai.y,aq.x-ai.x);var ag=Math.atan2(ap.y-ai.y,ap.x-ai.x);var al=Math.atan2(ao.y-ai.y,ao.x-ai.x);if(Math.abs(O.length(ai,ao)-ah)<8&&(((aj<ag&&ag<ak)||(ak<aj&&aj<ag)||(ag<ak&&ak<aj))==((aj<al&&al<ak)||(ak<aj&&aj<al)||(al<ak&&ak<aj)))){ar.part=0;ar.mouse1=ao;return true}}else{if(!am.path[(an+1)%am.path.length].arc&&!am.path[an%am.path.length].arc){if(Y(ao,O.xxe(am.path[(an)%am.path.length],am.path[(an+1)%am.path.length]))){ar.part=0;ar.mouse1=ao;return true}}}}},xxx:function(ai,ag,ah){if(ah.part==1){ai.path[ah.index].x=ag.x;ai.path[ah.index].y=ag.y}if(ah.part==0){this.xxv(ai,ag.x-ah.mouse1.x,ag.y-ah.mouse1.y);ah.mouse1=ag}},xxy:function(aq,ap){if(aq.notDone){return}var aw=Infinity;var ak;var am=null;var av=null;for(var au=0;au<aq.path.length;au++){av=null;if(aq.path[(au+1)%aq.path.length].arc&&!aq.path[au%aq.path.length].arc){var aj=O.xxa(aq.path[au%aq.path.length].x,aq.path[au%aq.path.length].y);var ai=O.xxa(aq.path[(au+2)%aq.path.length].x,aq.path[(au+2)%aq.path.length].y);var ah=O.xxa(aq.path[(au+1)%aq.path.length].x,aq.path[(au+1)%aq.path.length].y);var ax=O.xxh(O.xxm(O.xxb(aj,ah)),O.xxm(O.xxb(ai,ah)));var ar=O.length(ax,ah);var aA=Math.atan2(aj.y-ax.y,aj.x-ax.x);var az=Math.atan2(ai.y-ax.y,ai.x-ax.x);var ay=Math.atan2(ah.y-ax.y,ah.x-ax.x);var al=O.xxi(O.xxb(ap.p1,ap.p2),O.xxf(ax,ai));var an;var at=[];var ag=[];for(var ao=1;ao<=2;ao++){an=Math.atan2(al[ao].y-ax.y,al[ao].x-ax.x);at[ao]=(((az<ay&&ay<aA)||(aA<az&&az<ay)||(ay<aA&&aA<az))==((az<an&&an<aA)||(aA<az&&az<an)||(an<aA&&aA<az)))&&((O.length(al[ao],ap.p1)>O.length(al[ao],ap.p2)));ag[ao]=O.length(ap.p1,al[ao])}if(at[1]&&((!at[2])||ag[1]<ag[2])){av=al[1];ak=ag[1]}if(at[2]&&((!at[1])||ag[2]<ag[1])){av=al[2];ak=ag[2]}}else{if(!aq.path[(au+1)%aq.path.length].arc&&!aq.path[au%aq.path.length].arc){var al=O.xxg(O.xxb(ap.p1,ap.p2),O.xxb(aq.path[au%aq.path.length],aq.path[(au+1)%aq.path.length]));if((O.length(al,aq.path[au%aq.path.length])+O.length(al,aq.path[(au+1)%aq.path.length])-O.length(aq.path[au%aq.path.length],aq.path[(au+1)%aq.path.length])<1e-7)&&((O.length(al,ap.p1)+O.length(al,ap.p2)-O.xxk(ap)<1e-7)||(O.length(al,ap.p1)>O.length(al,ap.p2)))){ak=O.length(ap.p1,al);av=al}}}if(av){if(ak<aw&&ak>0.00001){aw=ak;am=av}}}if(am){return am}},shot:function(av,au){if(av.notDone){return}var aC=h.getContext("2d");aC.beginPath();aC.moveTo(av.path[0].x,av.path[0].y);var aJ=Infinity;var al;var aq=null;var aI=null;var aO;for(var aG=0;aG<av.path.length;aG++){aI=null;if(av.path[(aG+1)%av.path.length].arc&&!av.path[aG%av.path.length].arc){var ak=O.xxa(av.path[aG%av.path.length].x,av.path[aG%av.path.length].y);var ai=O.xxa(av.path[(aG+2)%av.path.length].x,av.path[(aG+2)%av.path.length].y);var ah=O.xxa(av.path[(aG+1)%av.path.length].x,av.path[(aG+1)%av.path.length].y);var aK=O.xxh(O.xxm(O.xxb(ak,ah)),O.xxm(O.xxb(ai,ah)));var ax=O.length(aK,ah);var aN=Math.atan2(ak.y-aK.y,ak.x-aK.x);var aM=Math.atan2(ai.y-aK.y,ai.x-aK.x);var aL=Math.atan2(ah.y-aK.y,ah.x-aK.x);var aH=(aM<aL&&aL<aN)||(aN<aM&&aM<aL)||(aL<aN&&aN<aM);var ap=O.xxi(O.xxb(au.p1,au.p2),O.xxf(aK,ai));var ar;var aD=[];var ag=[];for(var at=1;at<=2;at++){ar=Math.atan2(ap[at].y-aK.y,ap[at].x-aK.x);aD[at]=(((aM<aL&&aL<aN)||(aN<aM&&aM<aL)||(aL<aN&&aN<aM))==((aM<ar&&ar<aN)||(aN<aM&&aM<ar)||(ar<aN&&aN<aM)))&&((O.length(ap[at],au.p1)>O.length(ap[at],au.p2)));ag[at]=O.length(au.p1,ap[at])}if(aD[1]&&((!aD[2])||ag[1]<ag[2])){aI=ap[1];al=ag[1]}if(aD[2]&&((!aD[1])||ag[2]<ag[1])){aI=ap[2];al=ag[2]}aC.arc(aK.x,aK.y,ax,aN,aM,aH)}else{if(!av.path[(aG+1)%av.path.length].arc&&!av.path[aG%av.path.length].arc){var ap=O.xxg(O.xxb(au.p1,au.p2),O.xxb(av.path[aG%av.path.length],av.path[(aG+1)%av.path.length]));if((O.length(ap,av.path[aG%av.path.length])+O.length(ap,av.path[(aG+1)%av.path.length])-O.length(av.path[aG%av.path.length],av.path[(aG+1)%av.path.length])<1e-7)&&((O.length(ap,au.p1)+O.length(ap,au.p2)-O.xxk(au)<1e-7)||(O.length(ap,au.p1)>O.length(ap,au.p2)))){al=O.length(au.p1,ap);aI=ap}aC.lineTo(av.path[(aG+1)%av.path.length].x,av.path[(aG+1)%av.path.length].y)}}if(aI){if(al<aJ&&al>0.00001){aJ=al;aq=aI;aO=aG}}}if(aC.isPointInPath((au.p1.x+aq.x)*0.5,(au.p1.y+aq.y)*0.5)){var az=av.p}else{var az=1/av.p}if(av.path[(aO+1)%av.path.length].arc&&!av.path[aO%av.path.length].arc){var ak=O.xxa(av.path[aO%av.path.length].x,av.path[aO%av.path.length].y);var ai=O.xxa(av.path[(aO+2)%av.path.length].x,av.path[(aO+2)%av.path.length].y);var ah=O.xxa(av.path[(aO+1)%av.path.length].x,av.path[(aO+1)%av.path.length].y);var aK=O.xxh(O.xxm(O.xxb(ak,ah)),O.xxm(O.xxb(ai,ah)));var ax=O.length(aK,ah);var aN=Math.atan2(ak.y-aK.y,ak.x-aK.x);var aM=Math.atan2(ai.y-aK.y,ai.x-aK.x);var aL=Math.atan2(ah.y-aK.y,ah.x-aK.x);var aH=(aM<aL&&aL<aN)||(aN<aM&&aM<aL)||(aL<aN&&aN<aM);var aj=Math.atan2(aq.y-aK.y,aq.x-aK.x)-Math.PI/2;if(aj<=-Math.PI){aj=aj+Math.PI*2}var aw=Math.atan2(au.p1.y-aq.y,au.p1.x-aq.x);var am=(aj>=0&&aj>aw&&aw>(aj-Math.PI))||(aj<0&&(aw<aj||aw>(aj+Math.PI)));if(am){var aA=aj-Math.PI/2}else{var aA=aj+Math.PI/2}if(am!=aH){}else{}}else{if(!av.path[(aO+1)%av.path.length].arc&&!av.path[aO%av.path.length].arc){var aj=Math.atan2(av.path[aO%av.path.length].y-av.path[(aO+1)%av.path.length].y,av.path[aO%av.path.length].x-av.path[(aO+1)%av.path.length].x);var aw=Math.atan2(au.p1.y-aq.y,au.p1.x-aq.x);if((aj>=0&&aj>aw&&aw>(aj-Math.PI))||(aj<0&&(aw<aj||aw>(aj+Math.PI)))){var aA=aj-Math.PI/2}else{var aA=aj+Math.PI/2}}}if(Math.abs(Math.sin(aA-aw)*az)>1){var aF=aA*2-aw;au.p1=aq;au.p2=O.xxa(aq.x+Math.cos(aF),aq.y+Math.sin(aF))}else{var aF=aA+Math.PI-Math.asin(Math.sin(aA-aw)*az);var ao=(aA+Math.PI)-aF;var ay=aA-aw;var an=0.5*(Math.pow(Math.sin(ao-ay)/Math.sin(ao+ay),2)+Math.pow(Math.tan(ao-ay)/Math.tan(ao+ay),2));var aB=aA*2-aw;var aE=O.xxc(aq,O.xxa(aq.x+Math.cos(aB),aq.y+Math.sin(aB)));aE.brightness=au.brightness*an;aE.gap=au.gap;if(aE.brightness>0.01){t(aE)}au.p1=aq;au.p2=O.xxa(aq.x+Math.cos(aF),aq.y+Math.sin(aF));au.brightness=au.brightness*(1-an)}}};l.laser={xxr:function(ag){return{type:"laser",p1:ag,p2:O.xxa(ag.x+p,ag.y)}},xxs:l.lineobj.xxs,xxt:l.lineobj.xxt,xxu:l.lineobj.xxu,xxv:l.lineobj.xxv,xxw:l.lineobj.xxw,xxx:l.lineobj.xxx,xxn:function(ai,ah){var ag=ah.getContext("2d");ag.fillStyle="rgb(255,0,0)";ag.fillRect(ai.p1.x-2,ai.p1.y-2,5,5);ag.fillRect(ai.p2.x-2,ai.p2.y-2,3,3)},xxz:function(ah){var ag=O.xxc(ah.p1,ah.p2);ag.brightness=1;ag.gap=true;ag.isNew=true;t(ag)}};l.mirror={xxr:function(ag){return{type:"mirror",p1:ag,p2:O.xxa(ag.x+p,ag.y)}},xxs:l.lineobj.xxs,xxt:l.lineobj.xxt,xxu:l.lineobj.xxu,xxv:l.lineobj.xxv,xxw:l.lineobj.xxw,xxx:l.lineobj.xxx,xxy:l.lineobj.xxy,xxn:function(ai,ah){var ag=ah.getContext("2d");ag.strokeStyle="rgb(168,168,168)";ag.beginPath();ag.moveTo(ai.p1.x,ai.p1.y);ag.lineTo(ai.p2.x,ai.p2.y);ag.stroke()},shot:function(aj,ah){var ai=O.xxg(O.xxb(ah.p1,ah.p2),O.xxb(aj.p1,aj.p2));var ag=2*(Math.atan2(aj.p2.x-aj.p1.x,aj.p2.y-aj.p1.y)+Math.PI/2)-Math.atan2(ah.p2.x-ah.p1.x,ah.p2.y-ah.p1.y);ah.p1=ai;ah.p2=O.xxa(ai.x-Math.sin(ag),ai.y-Math.cos(ag))}};l.lens={p_name:"Focal length(px)",xxo:-1000,xxp:1000,xxq:1,xxr:function(ag){return{type:"lens",p1:ag,p2:O.xxa(ag.x+p,ag.y),p:100}},xxs:l.lineobj.xxs,xxt:l.lineobj.xxt,xxu:l.lineobj.xxu,xxv:l.lineobj.xxv,xxw:l.lineobj.xxw,xxx:l.lineobj.xxx,xxy:l.lineobj.xxy,xxn:function(ai,ah){var ag=ah.getContext("2d");ag.strokeStyle="rgba(192,192,192,0.5)";ag.lineWidth=5;ag.lineCap="round";ag.beginPath();ag.moveTo(ai.p1.x,ai.p1.y);ag.lineTo(ai.p2.x,ai.p2.y);ag.stroke();ag.lineWidth=1;ag.lineCap="butt"},shot:function(al,aq){var ao=O.xxg(O.xxb(aq.p1,aq.p2),O.xxb(al.p1,al.p2));var ar=O.xxm(al);var at=O.xxl(al);var ai=O.xxg(ar,O.parallel(O.xxb(al.p1,al.p2),aq.p1));var ah=O.length(ai,at);var ag=(ah*al.p)/(ah-al.p);var an=(ag*O.length(ai,aq.p1))/ah;var aj=O.xxg(ar,O.xxf(at,Math.abs(ag)));var ap=((ag>0)==(O.length(aj[1],ai)<O.length(aj[2],ai)))?aj[2]:aj[1];var ak=O.xxg(O.parallel(O.xxb(al.p1,al.p2),ap),O.xxf(ap,Math.abs(an)));var au=O.xxb(ao,((an>0)==(O.length(ak[1],aq.p1)>O.length(ak[2],aq.p1)))?ak[1]:ak[2]);var am=Math.atan2((au.p2.x-au.p1.x),(au.p2.y-au.p1.y));if(ag>0){aq.p1=ao;aq.p2=O.xxa(au.p1.x+Math.sin(am),au.p1.y+Math.cos(am))}else{aq.p1=ao;aq.p2=O.xxa(au.p1.x-Math.sin(am),au.p1.y-Math.cos(am))}}};l.blackline={xxr:function(ag){return{type:"blackline",p1:ag,p2:O.xxa(ag.x+p,ag.y)}},xxs:l.lineobj.xxs,xxt:l.lineobj.xxt,xxu:l.lineobj.xxu,xxv:l.lineobj.xxv,xxw:l.lineobj.xxw,xxx:l.lineobj.xxx,xxy:l.lineobj.xxy,xxn:function(ai,ah){var ag=ah.getContext("2d");ag.strokeStyle="rgb(64,64,64)";ag.beginPath();ag.moveTo(ai.p1.x,ai.p1.y);ag.lineTo(ai.p2.x,ai.p2.y);ag.stroke()},shot:function(ah,ag){ag.exist=false}};l.radiant={p_name:"Brightness",xxo:0,xxp:1,xxq:0.01,xxr:function(ag){return{type:"radiant",x:ag.x,y:ag.y,p:0.5}},xxs:function(ah,ag){ad()},xxt:function(ah,ag){},xxu:function(ah,ag){R=false},xxn:function(ai,ah){var ag=ah.getContext("2d");ag.fillStyle="rgb(0,255,0)";ag.fillRect(ai.x-2,ai.y-2,5,5)},xxv:function(ai,ah,ag){ai.x=ai.x+ah;ai.y=ai.y+ag;return ai},xxw:function(ah,ag){if(S(ag,ah)){return true}return false},xxx:function(ai,ag,ah){ai.x=ag.x;ai.y=ag.y;return{obj:ai}},xxz:function(aj){var ai=Math.PI*2/parseInt(n()*500);for(var ah=0;ah<(Math.PI*2-0.00001);ah=ah+ai){var ag=O.xxc(O.xxa(aj.x,aj.y),O.xxa(aj.x+Math.sin(ah),aj.y+Math.cos(ah)));ag.brightness=Math.min(aj.p/n(),1);ag.isNew=true;if(ah==0){ag.gap=true}t(ag)}}};l.parallel={p_name:"Brightness",xxo:0,xxp:1,xxq:0.01,xxr:function(ag){return{type:"parallel",p1:ag,p2:O.xxa(ag.x+p,ag.y),p:0.5}},xxs:l.lineobj.xxs,xxt:l.lineobj.xxt,xxu:l.lineobj.xxu,xxv:l.lineobj.xxv,xxw:l.lineobj.xxw,xxx:l.lineobj.xxx,xxn:function(aj,ai){var ah=ai.getContext("2d");var ag=Math.atan2(aj.p1.x-aj.p2.x,aj.p1.y-aj.p2.y)-Math.PI/2;ah.strokeStyle="rgb(0,255,0)";ah.lineWidth=4;ah.lineCap="butt";ah.beginPath();ah.moveTo(aj.p1.x+Math.sin(ag)*2,aj.p1.y+Math.cos(ag)*2);ah.lineTo(aj.p2.x+Math.sin(ag)*2,aj.p2.y+Math.cos(ag)*2);ah.stroke();ah.strokeStyle="rgba(128,128,128,255)";ah.lineWidth=2;ah.beginPath();ah.moveTo(aj.p1.x,aj.p1.y);ah.lineTo(aj.p2.x,aj.p2.y);ah.stroke();ah.lineWidth=1;ah.lineCap="butt"},xxz:function(ak){var ah=Math.atan2(ak.p1.x-ak.p2.x,ak.p1.y-ak.p2.y)-Math.PI/2;var al=O.xxk(ak)*n();var aj=(ak.p2.x-ak.p1.x)/al;var ai=(ak.p2.y-ak.p1.y)/al;for(i=0;i<=al;i++){x=ak.p1.x+i*aj;y=ak.p1.y+i*ai;var ag=O.xxc(O.xxa(x,y),O.xxa(x+Math.sin(ah),y+Math.cos(ah)));ag.brightness=Math.min(ak.p/n(),1);ag.isNew=true;if(i==0){ag.gap=true}t(ag)}}};l.arcmirror={xxr:function(ag){return{type:"arcmirror",p1:ag}},xxs:function(ah,ag){if(!ah.p2&&!ah.p3){ad();ah.p2=ag;return}if(ah.p2&&!ah.p3){ah.p2=ag;ad();ah.p3=ag;return}},xxt:function(ah,ag){if(!ah.p3&&Math.sqrt(Math.pow(ah.p1.x-ag.x,2)+Math.pow(ah.p1.y-ag.y,2))>=5){ah.p2=ag;ad();return}if(ah.p3&&Math.sqrt(Math.pow(ah.p2.x-ag.x,2)+Math.pow(ah.p2.y-ag.y,2))>=5){ah.p3=ag;ad();return}},xxu:function(ah,ag){if(ah.p2&&!ah.p3&&Math.sqrt(Math.pow(ah.p1.x-ag.x,2)+Math.pow(ah.p1.y-ag.y,2))>=5){ah.p3=ag;return}if(ah.p3&&Math.sqrt(Math.pow(ah.p2.x-ag.x,2)+Math.pow(ah.p2.y-ag.y,2))>=5){ah.p3=ag;ad();R=false;return}},xxn:function(am,ak){var aj=ak.getContext("2d");aj.fillStyle="rgb(255,0,255)";if(am.p3&&am.p2){var ah=O.xxh(O.xxm(O.xxb(am.p1,am.p3)),O.xxm(O.xxb(am.p2,am.p3)));var al=O.length(ah,am.p3);var ai=Math.atan2(am.p1.y-ah.y,am.p1.x-ah.x);var ag=Math.atan2(am.p2.y-ah.y,am.p2.x-ah.x);var an=Math.atan2(am.p3.y-ah.y,am.p3.x-ah.x);aj.strokeStyle="rgb(168,168,168)";aj.beginPath();aj.arc(ah.x,ah.y,al,ai,ag,(ag<an&&an<ai)||(ai<ag&&ag<an)||(an<ai&&ai<ag));aj.stroke();aj.fillRect(am.p3.x-2,am.p3.y-2,3,3);aj.fillStyle="rgb(255,0,0)";aj.fillRect(am.p1.x-2,am.p1.y-2,3,3);aj.fillRect(am.p2.x-2,am.p2.y-2,3,3)}else{if(am.p2){aj.fillStyle="rgb(255,0,0)";aj.fillRect(am.p1.x-2,am.p1.y-2,3,3);aj.fillRect(am.p2.x-2,am.p2.y-2,3,3)}else{aj.fillStyle="rgb(255,0,0)";aj.fillRect(am.p1.x-2,am.p1.y-2,3,3)}}},xxv:function(ai,ah,ag){ai.p1.x=ai.p1.x+ah;ai.p1.y=ai.p1.y+ag;ai.p2.x=ai.p2.x+ah;ai.p2.y=ai.p2.y+ag;ai.p3.x=ai.p3.x+ah;ai.p3.y=ai.p3.y+ag;return ai},xxw:function(am,an,ao){if(S(an,am.p1)){ao.part=1;return true}if(S(an,am.p2)){ao.part=2;return true}if(S(an,am.p3)){ao.part=3;return true}var ai=O.xxh(O.xxm(O.xxb(am.p1,am.p3)),O.xxm(O.xxb(am.p2,am.p3)));var ah=O.length(ai,am.p3);var ak=Math.atan2(am.p1.y-ai.y,am.p1.x-ai.x);var aj=Math.atan2(am.p2.y-ai.y,am.p2.x-ai.x);var ag=Math.atan2(am.p3.y-ai.y,am.p3.x-ai.x);var al=Math.atan2(an.y-ai.y,an.x-ai.x);if(Math.abs(O.length(ai,an)-ah)<8&&(((aj<ag&&ag<ak)||(ak<aj&&aj<ag)||(ag<ak&&ak<aj))==((aj<al&&al<ak)||(ak<aj&&aj<al)||(al<ak&&ak<aj)))){ao.part=0;ao.mouse1=an;return true}return false},xxx:function(ak,ag,aj){if(aj.part==1){ak.p1=ag}if(aj.part==2){ak.p2=ag}if(aj.part==3){ak.p3=ag}if(aj.part==0){var ai=aj.mouse1.x-ag.x;var ah=aj.mouse1.y-ag.y;ak.p1.x=ak.p1.x-ai;ak.p1.y=ak.p1.y-ah;ak.p2.x=ak.p2.x-ai;ak.p2.y=ak.p2.y-ah;ak.p3.x=ak.p3.x-ai;ak.p3.y=ak.p3.y-ah;aj.mouse1=ag}},xxy:function(an,ao){if(!an.p3){return}var ai=O.xxh(O.xxm(O.xxb(an.p1,an.p3)),O.xxm(O.xxb(an.p2,an.p3)));var ah=O.length(ai,an.p3);var ak=Math.atan2(an.p1.y-ai.y,an.p1.x-ai.x);var aj=Math.atan2(an.p2.y-ai.y,an.p2.x-ai.x);var ag=Math.atan2(an.p3.y-ai.y,an.p3.x-ai.x);var aq=O.xxi(O.xxb(ao.p1,ao.p2),O.xxf(ai,an.p2));var ap;var al=[];var ar=[];for(var am=1;am<=2;am++){ap=Math.atan2(aq[am].y-ai.y,aq[am].x-ai.x);al[am]=(((aj<ag&&ag<ak)||(ak<aj&&aj<ag)||(ag<ak&&ak<aj))==((aj<ap&&ap<ak)||(ak<aj&&aj<ap)||(ap<ak&&ak<aj)))&&((O.length(aq[am],ao.p1)>O.length(aq[am],ao.p2)));ar[am]=O.length(ao.p1,aq[am])}if(al[1]&&((!al[2])||ar[1]<ar[2])){return aq[1]}if(al[2]&&((!al[1])||ar[2]<ar[1])){return aq[2]}},shot:function(ak,ai){var ag=O.xxh(O.xxm(O.xxb(ak.p1,ak.p3)),O.xxm(O.xxb(ak.p2,ak.p3)));var aj=this.xxy(ak,ai);var ah=2*(-Math.atan2(ag.y-aj.y,ag.x-aj.x)+Math.PI/2)-Math.atan2(ai.p2.x-ai.p1.x,ai.p2.y-ai.p1.y);ai.p1=aj;ai.p2=O.xxa(aj.x-Math.sin(ah),aj.y-Math.cos(ah))}};var h;var J;var B=[];var o=0;var R=false;var d=-1;var T={};var A=-1;var C="";var G=[];var X=0;var P=0.1;var af=1;var D=false;var b=true;var p=20;var s=[];var w=0;var j=20;var f=0;var E=0;var M;var m="light";var z=-1;var aa=false;var Q=false;var e=false;var N=-1;var ac=false;window.onload=function(ag){h=document.getElementById("canvas1");h.width=window.innerWidth;h.height=window.innerHeight;H(C);if(document.getElementById("textarea1").value!=""){q()}else{U(m)}s[0]=document.getElementById("textarea1").value;document.getElementById("undo").disabled=true;document.getElementById("redo").disabled=true;h.onmousedown=function(ah){document.body.focus();Z(ah);return false};h.onmousemove=function(ah){a(ah)};h.onmouseup=function(ah){k(ah)};h.ontouchstart=function(ah){document.body.focus();Z(ah)};h.ontouchmove=function(ah){a(ah);ah.preventDefault()};h.ontouchend=function(ah){k(ah);ah.preventDefault()};h.ontouchcancel=function(ah){k(ah);F();ah.preventDefault()};document.getElementById("tool_laser").onclick=function(){H("laser")};document.getElementById("tool_radiant").onclick=function(){H("radiant")};document.getElementById("tool_parallel").onclick=function(){H("parallel")};document.getElementById("tool_mirror").onclick=function(){H("mirror")};document.getElementById("tool_arcmirror").onclick=function(){H("arcmirror")};document.getElementById("tool_lens").onclick=function(){H("lens")};document.getElementById("tool_refractor").onclick=function(){H("refractor")};document.getElementById("tool_blackline").onclick=function(){H("blackline")};document.getElementById("tool_").onclick=function(){H("")};document.getElementById("undo").onclick=F;document.getElementById("redo").onclick=r;document.getElementById("cleanAll").onclick=V;document.getElementById("accessJSON").onclick=u;document.getElementById("mode_light").onclick=function(){U("light")};document.getElementById("mode_extended_light").onclick=function(){U("extended_light")};document.getElementById("mode_images").onclick=function(){U("images")};document.getElementById("mode_observer").onclick=function(){U("observer")};document.getElementById("rayDensity").onchange=function(){K(Math.exp(this.value));ad()};document.getElementById("rayDensity").onmouseup=function(){g()};document.getElementById("rayDensity").ontouchend=function(){g()};document.getElementById("forceStop").onclick=function(){if(z!=-1){e=true}};document.getElementById("objAttr_range").onchange=function(){W(document.getElementById("objAttr_range").value)};document.getElementById("objAttr_range").onmouseup=function(){g()};document.getElementById("objAttr_range").ontouchend=function(){g()};document.getElementById("objAttr_text").onchange=function(){W(document.getElementById("objAttr_text").value)};document.getElementById("setAttrAll").onchange=function(){W(document.getElementById("objAttr_text").value);g()};document.getElementById("copy").onclick=function(){B[B.length]=JSON.parse(JSON.stringify(B[A]));ad();g()};document.getElementById("delete").onclick=function(){ae(A);ad();g()};document.getElementById("textarea1").onchange=function(){q();g()}};function ad(){ac=true;document.getElementById("forceStop").style.display="none";if(z!=-1){clearTimeout(z);z=-1;aa=false}if(!aa){aa=true;v()}}function v(){if(!ac){aa=false;return}ac=false;c();L.cls(h);Q=false;G=[];shotRayCount=0;for(var ah=0;ah<B.length;ah++){l[B[ah].type].xxn(B[ah],h);if(l[B[ah].type].xxz){l[B[ah].type].xxz(B[ah])}}ab();if(m=="observer"){var ag=h.getContext("2d");ag.globalAlpha=1;ag.beginPath();ag.fillStyle="blue";ag.arc(M.c.x,M.c.y,M.r,0,Math.PI*2,false);ag.fill()}N=new Date()}function t(ag){G[G.length]=ag}function n(){if(m=="images"||m=="observer"){return af}else{return P}}function ab(){z=-1;var au=new Date();var aq=1;h.getContext("2d").globalAlpha=aq;var ax;var ah;var ag;var aA;var ao;var av;var al;var am;var az;var ap=G.length;while(ap!=0&&!e){if(new Date()-au>200){document.getElementById("status").innerHTML=shotRayCount+""+ap+")";Q=true;z=setTimeout(ab,10);document.getElementById("forceStop").style.display="";return}ap=0;al=-1;ag=null;aA=null;for(var at=0;at<G.length;at++){if(G[at]&&G[at].exist){ao=null;av=-1;am=null;az=Infinity;ah=false;for(var aw=0;aw<B.length;aw++){if(l[B[aw].type].xxy){var ay=l[B[aw].type].xxy(B[aw],G[at]);if(typeof ay!="undefined"){var ak=O.length(G[at].p1,ay);if(ak<az&&ak>0.00001){ao=B[aw];av=aw;am=ay;az=ak}}}}h.getContext("2d").globalAlpha=aq*G[at].brightness;if(az==Infinity){if(m=="light"||m=="extended_light"){L.xxn(G[at],h,"rgb(255,255,128)")}if(m=="extended_light"&&!G[at].isNew){L.xxn(O.xxc(G[at].p1,O.xxa(G[at].p1.x*2-G[at].p2.x,G[at].p1.y*2-G[at].p2.y)),h,"rgb(255,128,0)")}if(m=="observer"){var an=O.xxi(G[at],M);if(an[1]){if(O.length(an[1],G[at].p1)>O.length(an[1],G[at].p2)){ah=true}}}}else{if(m=="light"||m=="extended_light"){L.xxn(O.xxe(G[at].p1,am),h,"rgb(255,255,128)")}if(m=="extended_light"&&!G[at].isNew){L.xxn(O.xxc(G[at].p1,O.xxa(G[at].p1.x*2-G[at].p2.x,G[at].p1.y*2-G[at].p2.y)),h,"rgb(255,128,0)");L.xxn(O.xxc(am,O.xxa(am.x*2-G[at].p2.x,am.y*2-G[at].p2.y)),h,"rgb(80,80,80)")}if(m=="observer"){var an=O.xxi(G[at],M);if(an[1]){if(O.length(G[at].p1,an[1])+O.length(an[1],am)-O.length(G[at].p1,am)<1e-7){ah=true}}}}if(m=="observer"&&ag){if(!G[at].gap){var aj=O.xxh(G[at],ag);if(ah){if(aA&&O.length(aA,aj)<5){if((O.length(aj,G[at].p1)+O.length(aj,an[1])-O.length(G[at].p1,an[1])<1e-7||O.length(aj,G[at].p1)<O.length(aj,an[1]))&&aA){h.getContext("2d").globalAlpha=aq*(G[at].brightness+ag.brightness)*0.5;var ai=(aj.x-G[at].p1.x)*(G[at].p2.x-G[at].p1.x)+(aj.y-G[at].p1.y)*(G[at].p2.y-G[at].p1.y);if(ai<0){L.xxn(aj,h,"rgb(255,128,0)")}else{if(ai<az){L.xxn(aj,h,"rgb(255,255,128)")}}L.xxn(O.xxe(an[1],aj),h,"rgb(0,0,255)")}else{L.xxn(O.xxc(an[1],G[at].p1),h,"rgb(0,0,255)")}}else{L.xxn(O.xxc(an[1],G[at].p1),h,"rgb(0,0,255)")}}aA=aj}else{aA=null}}if(m=="images"&&ag){if(!G[at].gap){var aj=O.xxh(G[at],ag);if(aA&&O.length(aA,aj)<5){h.getContext("2d").globalAlpha=aq*(G[at].brightness+ag.brightness)*0.5;var ai=(aj.x-G[at].p1.x)*(G[at].p2.x-G[at].p1.x)+(aj.y-G[at].p1.y)*(G[at].p2.y-G[at].p1.y);if(ai<0){L.xxn(aj,h,"rgb(255,128,0)")}else{if(ai<az){L.xxn(aj,h,"rgb(255,255,128)")}else{L.xxn(aj,h,"rgb(80,80,80)")}}}aA=aj}}if(al!=av){G[at].gap=true}G[at].isNew=false;ag={p1:G[at].p1,p2:G[at].p2};al=av;if(ao){l[ao.type].shot(ao,G[at])}else{G[at]=null}shotRayCount=shotRayCount+1;if(G[at]&&G[at].exist){ap=ap+1}}}}h.getContext("2d").globalAlpha=1;for(var aw=0;aw<B.length;aw++){l[B[aw].type].xxn(B[aw],h)}if(m=="observer"){var ar=h.getContext("2d");ar.globalAlpha=1;ar.beginPath();ar.fillStyle="blue";ar.arc(M.c.x,M.c.y,M.r,0,Math.PI*2,false);ar.fill()}if(e){document.getElementById("status").innerHTML=shotRayCount+"";e=false}else{if(Q){document.getElementById("status").innerHTML=shotRayCount+""}else{document.getElementById("status").innerHTML=shotRayCount+""+(new Date()-au)+"ms"}}document.getElementById("forceStop").style.display="none";setTimeout(v,10)}function S(ah,ag){return Math.sqrt(Math.pow(ag.x-ah.x,2)+Math.pow(ag.y-ah.y,2))<15}function Y(ag,ah){return O.length(ag,ah.p1)+O.length(ag,ah.p2)-O.xxk(ah)<2}function Z(ai){if(document.getElementById("grid").checked!=ai.ctrlKey){J=O.xxa(Math.round((ai.pageX-ai.target.offsetLeft)/p)*p,Math.round((ai.pageY-ai.target.offsetTop)/p)*p)}else{J=O.xxa(ai.pageX-ai.target.offsetLeft,ai.pageY-ai.target.offsetTop)}if(R){l[B[B.length-1].type].xxs(B[B.length-1],J)}else{if(m=="observer"){if(O.length(J,M.c)<M.r){d=-4;return}}var ah;if((document.getElementById("dragObj").checked!=ai.altKey)&&!ai.shiftKey){for(var ag=0;ag<B.length;ag++){if(typeof B[ag]!="undefined"){if(l[B[ag].type].xxw(B[ag],J,T)){I(ag);d=ag;return}}}}if(d==-1){if((C=="")||ai.shiftKey){d=-3;T={mouse1:J};document.getElementById("obj_settings").style.display="none"}else{B[B.length]=l[C].xxr(J);R=true;if(B[A]){if(B[A].type==B[B.length-1].type){B[B.length-1].p=B[A].p}}I(B.length-1);l[B[B.length-1].type].xxs(B[B.length-1],J)}}}}function a(al){if(document.getElementById("grid").checked!=al.ctrlKey){J=O.xxa(Math.round((al.pageX-al.target.offsetLeft)/p)*p,Math.round((al.pageY-al.target.offsetTop)/p)*p)}else{J=O.xxa(al.pageX-al.target.offsetLeft,al.pageY-al.target.offsetTop)}if(R){l[B[B.length-1].type].xxt(B[B.length-1],J)}else{var ag=m=="observed_light"||m=="observed_images";if(d==-4){M.c=J;ad()}var ak;if(d>=0){l[B[d].type].xxx(B[d],J,T);ad()}if(d==-3){var aj=J.x-T.mouse1.x;var ai=J.y-T.mouse1.y;for(var ah=0;ah<B.length;ah++){l[B[ah].type].xxv(B[ah],aj,ai)}T.mouse1=J;if(M){M.c.x+=aj;M.c.y+=ai}ad()}}}function k(ag){if(R){l[B[B.length-1].type].xxu(B[B.length-1],J);if(!R){g()}}else{d=-1;T={};g()}}window.onresize=function(ag){h.width=window.innerWidth;h.height=window.innerHeight;ad()};function I(ah){if(ah<0||ah>=B.length){A=-1;document.getElementById("obj_settings").style.display="none";return}A=ah;document.getElementById("obj_name").innerHTML=document.getElementById("tool_"+B[ah].type).value;if(l[B[ah].type].p_name){document.getElementById("p_box").style.display="";var ag=B[ah].p;document.getElementById("p_name").innerHTML=l[B[ah].type].p_name;document.getElementById("objAttr_range").min=l[B[ah].type].xxo;document.getElementById("objAttr_range").max=l[B[ah].type].xxp;document.getElementById("objAttr_range").step=l[B[ah].type].xxq;document.getElementById("objAttr_range").value=ag;document.getElementById("objAttr_text").value=ag;B[ah].p=ag;for(var ai=0;ai<B.length;ai++){if(ai!=A&&B[ai].type==B[A].type){document.getElementById("setAttrAll_box").style.display="";break}if(ai==B.length-1){document.getElementById("setAttrAll_box").style.display="none"}}}else{document.getElementById("p_box").style.display="none"}document.getElementById("obj_settings").style.display=""}function W(ah){B[A].p=ah;document.getElementById("objAttr_text").value=ah;document.getElementById("objAttr_range").value=ah;if(document.getElementById("setAttrAll").checked){for(var ag=0;ag<B.length;ag++){if(B[ag].type==B[A].type){B[ag].p=ah}}}ad()}function ae(ag){for(var ah=ag;ah<B.length-1;ah++){B[ah]=JSON.parse(JSON.stringify(B[ah+1]))}R=false;B.length=B.length-1;A--;I(A)}function g(){w=(w+1)%j;f=w;document.getElementById("undo").disabled=false;document.getElementById("redo").disabled=true;s[w]=document.getElementById("textarea1").value;if(f==E){E=(E+1)%j}}function F(){if(R){R=false;B.length--;I(-1);ad();return}w=(w+(j-1))%j;document.getElementById("textarea1").value=s[w];q();document.getElementById("redo").disabled=false;if(w==E){document.getElementById("undo").disabled=true}}function r(){R=false;w=(w+1)%j;document.getElementById("textarea1").value=s[w];q();document.getElementById("undo").disabled=false;if(w==f){document.getElementById("redo").disabled=true}}function V(){R=false;B.length=0;I(-1);ad();g()}window.onkeydown=function(ag){if(ag.ctrlKey&&ag.keyCode==90){F();return false}if(ag.ctrlKey&&ag.keyCode==68){B[B.length]=JSON.parse(JSON.stringify(B[A]));ad();g();return false}if(ag.altKey&&ag.keyCode==78){V();return false}if(ag.keyCode==46){ae(A);ad();g();return false}};function c(){document.getElementById("textarea1").value=JSON.stringify({objs:B,mode:m,rayDensity_light:P,rayDensity_images:af,observer:M})}function q(){jsonData=JSON.parse(document.getElementById("textarea1").value);B=jsonData.objs;P=jsonData.rayDensity_light;af=jsonData.rayDensity_images;M=jsonData.observer;U(jsonData.mode);I(A)}function u(){if(document.getElementById("textarea1").style.display=="none"){document.getElementById("textarea1").style.display="";document.getElementById("textarea1").select()}else{document.getElementById("textarea1").style.display="none"}}function H(ag){document.getElementById("tool_"+C).style.backgroundColor="#E9E9E9";document.getElementById("tool_"+ag).style.backgroundColor="#C0C0C0";C=ag}function U(ag){document.getElementById("mode_"+m).style.backgroundColor="#E9E9E9";document.getElementById("mode_"+ag).style.backgroundColor="#C0C0C0";m=ag;if(m=="images"||m=="observer"){document.getElementById("rayDensity").value=Math.log(af)}else{document.getElementById("rayDensity").value=Math.log(P)}if(m=="observer"&&!M){M=O.xxf(O.xxa(h.width*0.5,h.height*0.5),20)}ad()}function K(ag){if(m=="images"||m=="observer"){af=ag}else{P=ag}}})();
